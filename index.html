<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen">
<title>Retro Hunt</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { 
    margin:0; 
    font-family:'Arial', sans-serif; 
    overflow:hidden; 
    background:#000;
    user-select:none;
    -webkit-user-select:none;
    -webkit-touch-callout:none;
    -webkit-tap-highlight-color:transparent;
    position:fixed;
    width:100%;
    height:100%;
    overscroll-behavior:none;
    touch-action:none;
  }
  #mainMenu {
    position:fixed; top:0; left:0;
    width:100%; height:100%;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display:flex; flex-direction:column;
    align-items:center; justify-content:center; z-index:100;
  }
  #mainMenu h1 {
    font-size:72px; color:#fff;
    text-shadow:0 0 20px rgba(255,255,255,0.5);
    margin-bottom:60px; letter-spacing:4px;
  }
  #mainMenu button {
    padding:20px 60px; margin:15px;
    background:#4CAF50; color:white; border:none;
    border-radius:12px; cursor:pointer; font-size:24px;
    font-weight:bold; box-shadow:0 6px 20px rgba(0,0,0,0.3);
    transition:all 0.3s;
    min-height:60px;
    min-width:200px;
  }
  #mainMenu button:hover, #mainMenu button:active {
    background:#45a049; transform:translateY(-3px);
    box-shadow:0 8px 25px rgba(0,0,0,0.4);
  }
  #shopMenu {
    position:fixed; top:0; left:0;
    width:100%; height:100%;
    background:linear-gradient(135deg, #232526 0%, #414345 100%);
    display:none; flex-direction:column;
    align-items:center; padding:40px 20px; z-index:100; overflow-y:auto;
    -webkit-overflow-scrolling:touch;
  }
  #shopMenu h1 { font-size:48px; color:#fff; margin-bottom:10px; }
  #shopMenu .shopSubtitle { color:#aaa; font-size:16px; margin-bottom:30px; text-align:center; }
  .shopGrid {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
    gap:30px; max-width:1200px; width:100%; margin-bottom:40px;
  }
  .shopItem {
    background:rgba(255,255,255,0.1); border-radius:12px;
    padding:25px; text-align:center; color:#fff;
    border:2px solid rgba(255,255,255,0.2);
  }
  .shopItem h3 { font-size:24px; margin-bottom:15px; }
  .shopItem p { margin:10px 0; font-size:14px; opacity:0.8; }
  .shopItem button {
    margin-top:15px; padding:15px 30px; background:#4CAF50;
    color:white; border:none; border-radius:8px;
    cursor:pointer; font-size:16px; font-weight:bold;
    min-height:50px;
  }
  .shopItem button:disabled { background:#555; cursor:not-allowed; }
  .shopItem.unlocked { border-color:#4CAF50; background:rgba(76,175,80,0.2); }
  .shopItem.equipped { border-color:#FFD700; background:rgba(255,215,0,0.2); }
  #backToMenu {
    padding:15px 40px; background:#ff9800; color:white;
    border:none; border-radius:8px; cursor:pointer;
    font-size:18px; font-weight:bold;
    min-height:55px;
  }
  #ui {
    position:fixed; top:10px; left:10px;
    background:rgba(255,255,255,0.95);
    padding:12px 16px; border-radius:12px;
    box-shadow:0 4px 10px rgba(0,0,0,0.3);
    z-index:10; display:none;
    max-width:calc(100% - 20px);
  }
  #ui div { margin:4px 0; font-size:14px; }
  #ui b { display:inline-block; width:90px; }
  #ui select { padding:6px 10px; border-radius:4px; border:1px solid #ccc; font-size:14px; }
  
  /* Mobile Shoot Button */
  #shootButton {
    position:fixed;
    bottom:env(safe-area-inset-bottom, 20px);
    right:env(safe-area-inset-right, 20px);
    width:90px;
    height:90px;
    background:radial-gradient(circle, #ff4444 0%, #cc0000 100%);
    border:4px solid rgba(255,255,255,0.8);
    border-radius:50%;
    display:none;
    z-index:30;
    box-shadow:0 6px 20px rgba(0,0,0,0.5);
    font-size:32px;
    color:white;
    align-items:center;
    justify-content:center;
    user-select:none;
    -webkit-user-select:none;
    touch-action:none;
    font-weight:bold;
  }
  #shootButton:active {
    transform:scale(0.95);
    box-shadow:0 4px 15px rgba(0,0,0,0.4);
    background:radial-gradient(circle, #ff6666 0%, #dd0000 100%);
  }
  
  /* Hit Flash Effect */
  #hitFlash {
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(76,175,80,0.3);
    pointer-events:none;
    opacity:0;
    z-index:5;
    transition:opacity 0.1s;
  }
  
  #gameOver {
    position:fixed; top:50%; left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.95); color:white;
    padding:40px 30px; border-radius:16px;
    text-align:center; display:none; z-index:20;
    box-shadow:0 8px 32px rgba(0,0,0,0.8);
    max-width:90%;
  }
  #gameOver h1 { font-size:48px; margin-bottom:20px; color:#ff6b6b; }
  #gameOver .finalScore { font-size:32px; margin:20px 0; color:#4CAF50; }
  #gameOver .stats { font-size:18px; margin:10px 0; opacity:0.9; }
  #gameOver button {
    margin-top:30px; padding:15px 40px; background:#4CAF50;
    color:white; border:none; border-radius:8px;
    cursor:pointer; font-size:18px; font-weight:bold;
    min-height:55px;
  }
  #gameOver button:hover { background:#45a049; transform:scale(1.05); }
  #missedWarning {
    position:fixed; top:50%; left:50%;
    transform:translate(-50%, -50%);
    background:rgba(255,0,0,0.9); color:white;
    padding:30px 50px; border-radius:12px;
    font-size:32px; font-weight:bold;
    display:none; z-index:25; animation:pulse 0.5s;
  }
  #levelUpBanner {
    position:fixed; top:20%; left:50%;
    transform:translateX(-50%);
    background:rgba(76,175,80,0.95); color:white;
    padding:20px 50px; border-radius:14px;
    font-size:30px; font-weight:bold;
    display:none; z-index:26; text-align:center;
    box-shadow:0 4px 20px rgba(0,0,0,0.4);
    animation:popIn 0.3s ease;
  }
  @keyframes popIn {
    0% { transform:translateX(-50%) scale(0.7); opacity:0; }
    100% { transform:translateX(-50%) scale(1); opacity:1; }
  }
  @keyframes pulse {
    0%, 100% { transform:translate(-50%, -50%) scale(1); }
    50% { transform:translate(-50%, -50%) scale(1.1); }
  }
  #pauseOverlay {
    position:fixed; top:50%; left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.9); color:white;
    padding:30px 50px; border-radius:12px;
    text-align:center; display:none; z-index:15; font-size:32px;
  }
  canvas { display:block; touch-action:none; }
  
  @media (max-width: 768px) {
    #mainMenu h1 { font-size:48px; margin-bottom:40px; }
    #mainMenu button { font-size:20px; padding:18px 40px; margin:12px; }
    #ui { font-size:12px; padding:10px 14px; top:env(safe-area-inset-top, 10px); }
    #ui b { width:70px; }
    #ui select { padding:5px 8px; font-size:13px; }
    #gameOver { padding:30px 20px; }
    #gameOver h1 { font-size:36px; }
    #gameOver .finalScore { font-size:26px; }
    #gameOver .stats { font-size:16px; }
    .shopGrid { grid-template-columns:1fr; padding:0 10px; }
    #shopMenu { padding:20px 10px; }
    #shootButton { 
      bottom:max(env(safe-area-inset-bottom), 20px);
      right:max(env(safe-area-inset-right), 20px);
    }
  }
  
  @supports(padding:max(0px)) {
    body {
      padding-left:env(safe-area-inset-left);
      padding-right:env(safe-area-inset-right);
      padding-top:env(safe-area-inset-top);
      padding-bottom:env(safe-area-inset-bottom);
    }
  }
</style>
</head>
<body>

<div id="mainMenu">
  <h1>RETRO HUNT</h1>
  <button id="playBtn">PLAY</button>
  <button id="shopBtn">SHOP</button>
</div>

<div id="shopMenu">
  <h1>WEAPON SHOP</h1>
  <p class="shopSubtitle">Hit targets during gameplay to permanently unlock weapons!</p>
  <div class="shopGrid" id="shopGrid"></div>
  <button id="backToMenu">BACK TO MENU</button>
</div>

<div id="ui">
  <div><b>Score:</b> <span id="score">0</span></div>
  <div><b>Hits:</b> <span id="hitsDisplay">0</span></div>
  <div><b>Level:</b> <span id="level">1</span></div>
  <div><b>Next Lvl:</b> <span id="nextLevelInfo">â€”</span></div>
  <div><b>Accuracy:</b> <span id="accuracy">100</span>%</div>
  <div><b>Misses:</b> <span id="misses">0</span>/10</div>
  <div><b>Best Hits:</b> <span id="bestHitsDisplay">0</span></div>
  <div><b>Map:</b>
    <select id="mapSelect">
      <option value="sky">Sunny Sky</option>
      <option value="sunset">Sunset</option>
      <option value="night">Night</option>
      <option value="space">Space</option>
      <option value="forest">Forest</option>
      <option value="ocean">Ocean</option>
      <option value="desert">Desert</option>
      <option value="grid">Arcade Grid</option>
      <option value="neonCyber">Neon Cyber Grid</option>
      <option value="retroCity">Retro City Skyline</option>
      <option value="synthSpace">Space Synthwave</option>
      <option value="hyperspace">Hyperspace Warp</option>
    </select>
  </div>
  <div><b>Crosshair:</b>
    <select id="crosshairSelect">
      <option value="dot">Dot</option>
      <option value="scope">Scope</option>
      <option value="cross">Cross</option>
    </select>
  </div>
</div>

<div id="gameOver">
  <h1>GAME OVER!</h1>
  <div class="finalScore">Final Score: <span id="finalScoreValue">0</span></div>
  <div class="stats">Level Reached: <span id="finalLevel">1</span></div>
  <div class="stats">Total Hits: <span id="finalHits">0</span></div>
  <div class="stats">Accuracy: <span id="finalAccuracy">100</span>%</div>
  <div class="stats">Enemies Hit: <span id="enemiesHit">0</span></div>
  <div class="stats">Bosses Defeated: <span id="bossesDefeated">0</span></div>
  <div class="stats" id="newUnlockMsg" style="color:#FFD700;font-weight:bold;display:none;"></div>
  <button id="playAgainBtn">PLAY AGAIN</button>
</div>

<div id="pauseOverlay">
  PAUSED<br><span style="font-size:18px;">(Press SPACE to resume)</span>
</div>
<div id="missedWarning">TOO MANY MISSES!</div>
<div id="levelUpBanner">ðŸŽ‰ LEVEL UP!</div>
<div id="hitFlash"></div>

<div id="shootButton">ðŸ”¥</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const shootButton = document.getElementById('shootButton');
const hitFlash = document.getElementById('hitFlash');

// Mobile detection
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                 ('ontouchstart' in window) || 
                 (navigator.maxTouchPoints > 0);

// Mobile adjustment multipliers
const MOBILE_SIZE_MULT = 1.3;  // +30% hitbox
const MOBILE_SPEED_MULT = 0.8;  // -20% speed
const MOBILE_EDGE_MARGIN = 0.15; // Keep 15% away from edges

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);
window.addEventListener('orientationchange', () => {
  setTimeout(resizeCanvas, 100);
});

// Prevent scrolling and zooming
document.addEventListener('touchmove', function(e) {
  if (running) {
    e.preventDefault();
  }
}, { passive: false });

document.addEventListener('gesturestart', function(e) {
  e.preventDefault();
}, { passive: false });

// â”€â”€ LEVEL THRESHOLDS (200 levels) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LEVEL_STEPS = [
  { hits:50,   level:3  },
  { hits:80,   level:5  },
  { hits:120,  level:7  },
  { hits:150,  level:10 },
  { hits:190,  level:13 },
  { hits:250,  level:16 },
  { hits:300,  level:20 },
  { hits:330,  level:25 },
  { hits:400,  level:30 },
  { hits:460,  level:33 },
  { hits:530,  level:36 },
  { hits:610,  level:39 },
  { hits:700,  level:42 },
  { hits:800,  level:45 },
  { hits:910,  level:47 },
  { hits:1030, level:50 },
  { hits:1180, level:53 },
  { hits:1350, level:56 },
  { hits:1540, level:59 },
  { hits:1750, level:62 },
  { hits:1980, level:65 },
  { hits:2230, level:68 },
  { hits:2510, level:71 },
  { hits:2820, level:74 },
  { hits:3160, level:76 },
  { hits:3530, level:79 },
  { hits:3940, level:82 },
  { hits:4390, level:85 },
  { hits:4880, level:88 },
  { hits:5430, level:91 },
  { hits:6030, level:93 },
  { hits:6780, level:95 },
  { hits:7680, level:97 },
  { hits:8780, level:99 },
  { hits:10000, level:100 },
  { hits:11500, level:102 },
  { hits:13200, level:104 },
  { hits:15100, level:106 },
  { hits:17200, level:108 },
  { hits:19500, level:110 },
  { hits:22000, level:112 },
  { hits:24700, level:114 },
  { hits:27600, level:116 },
  { hits:30700, level:118 },
  { hits:34000, level:120 },
  { hits:37500, level:122 },
  { hits:41200, level:124 },
  { hits:45100, level:126 },
  { hits:49200, level:128 },
  { hits:53500, level:130 },
  { hits:58000, level:132 },
  { hits:62700, level:134 },
  { hits:67600, level:136 },
  { hits:72700, level:138 },
  { hits:78000, level:140 },
  { hits:83500, level:142 },
  { hits:89200, level:144 },
  { hits:95100, level:146 },
  { hits:101200, level:148 },
  { hits:107500, level:150 },
  { hits:114000, level:152 },
  { hits:120700, level:154 },
  { hits:127600, level:156 },
  { hits:134700, level:158 },
  { hits:142000, level:160 },
  { hits:149500, level:162 },
  { hits:157200, level:164 },
  { hits:165100, level:166 },
  { hits:173200, level:168 },
  { hits:181500, level:170 },
  { hits:190000, level:172 },
  { hits:198700, level:174 },
  { hits:207600, level:176 },
  { hits:216700, level:178 },
  { hits:226000, level:180 },
  { hits:235500, level:182 },
  { hits:245200, level:184 },
  { hits:255100, level:186 },
  { hits:265200, level:188 },
  { hits:275500, level:190 },
  { hits:286000, level:192 },
  { hits:296700, level:194 },
  { hits:307600, level:196 },
  { hits:318700, level:198 },
  { hits:330000, level:200 },
];

function getLevelForHits(h) {
  let lv = 1;
  for (const step of LEVEL_STEPS) {
    if (h >= step.hits) lv = step.level;
    else break;
  }
  return lv;
}
function getNextStep(h) {
  for (const step of LEVEL_STEPS) { if (h < step.hits) return step; }
  return null;
}

// â”€â”€ WEAPONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const weapons = [
  { id:'pistol',    name:'Pistol',           hitsRequired:0,    description:'Classic sidearm â€” always available' },
  { id:'revolver',  name:'Revolver',          hitsRequired:50,   description:'Heavy firepower â€” 50 hits (Level 3)' },
  { id:'shotgun',   name:'Shotgun',           hitsRequired:80,   description:'Spread shot â€” 80 hits (Level 5)' },
  { id:'uzi',       name:'Uzi',               hitsRequired:120,  description:'Compact SMG â€” 120 hits (Level 7)' },
  { id:'rifle',     name:'Assault Rifle',     hitsRequired:150,  description:'Rapid fire â€” 150 hits (Level 10)' },
  { id:'sniper',    name:'Sniper Rifle',      hitsRequired:190,  description:'Precision â€” 190 hits (Level 13)' },
  { id:'minigun',   name:'Minigun',           hitsRequired:250,  description:'Shred everything â€” 250 hits (Level 16)' },
  { id:'railgun',   name:'Rail Gun',          hitsRequired:300,  description:'Energy weapon â€” 300 hits (Level 20)' },
  { id:'plasma',    name:'Plasma Cannon',     hitsRequired:330,  description:'Alien tech â€” 330 hits (Level 25)' },
  { id:'laser',     name:'Laser Beam',        hitsRequired:400,  description:'Continuous beam â€” 400 hits (Level 30)' },
  { id:'vortex',    name:'Vortex Blaster',    hitsRequired:460,  description:'Spinning chaos â€” 460 hits (Level 33)' },
  { id:'thunder',   name:'Thunder Cannon',    hitsRequired:530,  description:'Electric burst â€” 530 hits (Level 36)' },
  { id:'cryo',      name:'Cryo Freezer',      hitsRequired:610,  description:'Ice shards â€” 610 hits (Level 39)' },
  { id:'inferno',   name:'Inferno Launcher',  hitsRequired:700,  description:'Napalm spray â€” 700 hits (Level 42)' },
  { id:'gravity',   name:'Gravity Gun',       hitsRequired:800,  description:'Warps spacetime â€” 800 hits (Level 45)' },
  { id:'quantum',   name:'Quantum Cannon',    hitsRequired:910,  description:'Fires in all dimensions â€” 910 hits (Level 47)' },
  { id:'void',      name:'Void Eraser',       hitsRequired:1030, description:'Deletes reality â€” 1030 hits (Level 50)' },
  { id:'nova',      name:'Nova Burster',      hitsRequired:1350, description:'Star-born explosion â€” 1350 hits (Level 56)' },
  { id:'omega',     name:'Omega Destroyer',   hitsRequired:1980, description:'The penultimate weapon â€” 1980 hits (Level 65)' },
  { id:'celestialbeam', name:'Celestial Beam', hitsRequired:3530, description:'MAXIMUM POWER â€” 3530 hits (Level 79)' },
];

// â”€â”€ PERSISTENT STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let highScore       = parseInt(localStorage.getItem('retroHuntHighScore') || '0');
let allTimeHits     = parseInt(localStorage.getItem('retroHuntAllTimeHits') || '0');
let unlockedWeapons = JSON.parse(localStorage.getItem('retroHuntWeapons') || '["pistol"]');
if (!unlockedWeapons.includes('pistol')) unlockedWeapons.push('pistol');

function saveProgress() {
  localStorage.setItem('retroHuntHighScore',   highScore.toString());
  localStorage.setItem('retroHuntAllTimeHits', allTimeHits.toString());
  localStorage.setItem('retroHuntWeapons',     JSON.stringify(unlockedWeapons));
}
function checkAndUnlockWeapons() {
  const nu = [];
  for (const w of weapons) {
    if (allTimeHits >= w.hitsRequired && !unlockedWeapons.includes(w.id)) {
      unlockedWeapons.push(w.id); nu.push(w.name);
    }
  }
  if (nu.length) saveProgress();
  return nu;
}

// â”€â”€ GAME STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let score=0, level=1, prevLevel=1;
let enemies=[], boss=null;
let running=false, paused=false;
let map='sky', crosshair='dot', blaster='pistol';
let enemiesHitCount=0, bossesDefeatedCount=0;
let shotsHit=0, shotsFired=0, missedShots=0, sessionHits=0;
let mouseX=canvas.width/2, mouseY=canvas.height/2;
let spawnInterval=null, gunRecoil=0, muzzleFlash=0;

const GUN_X = () => canvas.width / 2;
const GUN_Y = () => canvas.height * 0.85;

// â”€â”€ BACKGROUND STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let stars = [];
for (let i=0;i<(isMobile?100:200);i++) stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,size:Math.random()*2,speed:Math.random()*0.5+0.1});

let cyberTime = 0;
const cyberParticles = [];
for (let i=0;i<(isMobile?30:60);i++) cyberParticles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,vx:(Math.random()-0.5)*1.5,vy:(Math.random()-0.5)*1.5,size:Math.random()*3+1,hue:Math.random()*60+180});

const cityBuildings = [];
for (let i=0;i<(isMobile?15:30);i++){
  cityBuildings.push({x:i*(canvas.width/(isMobile?14:28)),w:40+Math.random()*60,h:80+Math.random()*280,windows:[]});
  for(let j=0;j<20;j++) cityBuildings[i].windows.push({ox:8+Math.floor(Math.random()*4)*14,oy:10+j*14,lit:Math.random()>0.4});
}

const warpStars = [];
for(let i=0;i<(isMobile?150:300);i++) warpStars.push({angle:Math.random()*Math.PI*2,dist:Math.random()*0.4+0.05,speed:Math.random()*0.012+0.004,hue:Math.floor(Math.random()*360),thickness:Math.random()*2+0.5});

const nebulaTime = {t:0};

document.getElementById('bestHitsDisplay').textContent = allTimeHits;

// â”€â”€ AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let audioCtx, musicInterval;
function beep(freq,dur,type='square',vol=0.1){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=type;o.frequency.value=freq;g.gain.value=vol;o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+dur);}
function playShoot(){beep(700,0.05);}
function playRevolverShoot(){beep(400,0.1,'sine',0.12);}
function playSpreadShoot(){beep(900,0.08,'triangle');}
function playUziShoot(){beep(800,0.02,'square',0.08);}
function playRapidShoot(){beep(600,0.03,'sine');}
function playSniperShoot(){beep(400,0.15,'sine',0.15);}
function playMinigunShoot(){beep(500,0.015,'sawtooth',0.1);}
function playRailgunShoot(){beep(200,0.2,'sine',0.15);}
function playPlasmaShoot(){beep(350,0.12,'triangle',0.12);}
function playLaserShoot(){beep(1000,0.3,'sine',0.08);}
function playVortexShoot(){beep(600,0.1,'sawtooth',0.1);setTimeout(()=>beep(400,0.1,'sawtooth',0.08),50);}
function playThunderShoot(){beep(150,0.15,'sawtooth',0.18);setTimeout(()=>beep(300,0.1,'square',0.1),40);}
function playCryoShoot(){beep(1200,0.12,'sine',0.09);setTimeout(()=>beep(900,0.08,'sine',0.06),60);}
function playInfernoShoot(){beep(250,0.18,'sawtooth',0.14);setTimeout(()=>beep(180,0.12,'sawtooth',0.1),50);}
function playGravityShoot(){beep(80,0.25,'sine',0.18);setTimeout(()=>beep(100,0.2,'triangle',0.12),80);}
function playQuantumShoot(){beep(1500,0.05,'sine',0.08);setTimeout(()=>beep(500,0.1,'sine',0.1),30);setTimeout(()=>beep(1000,0.08,'sine',0.08),60);}
function playVoidShoot(){beep(60,0.3,'sawtooth',0.2);setTimeout(()=>beep(40,0.25,'sawtooth',0.15),100);}
function playNovaShoot(){beep(800,0.08,'triangle',0.12);setTimeout(()=>beep(1100,0.12,'triangle',0.1),40);}
function playOmegaShoot(){beep(300,0.15,'sawtooth',0.15);setTimeout(()=>beep(150,0.2,'sawtooth',0.15),60);setTimeout(()=>beep(600,0.1,'square',0.1),120);}
function playCelestialbeamShoot(){beep(2000,0.05,'sine',0.06);setTimeout(()=>beep(100,0.4,'sawtooth',0.2),20);setTimeout(()=>beep(2000,0.3,'sine',0.08),60);}
function playHit(){beep(180,0.08,'sawtooth');}
function playBoss(){beep(90,0.4,'triangle',0.2);}
function playLevelUp(){beep(440,0.1,'square',0.15);setTimeout(()=>beep(554,0.1,'square',0.15),100);setTimeout(()=>beep(659,0.2,'square',0.15),200);}
function startBackgroundMusic(){if(musicInterval)clearInterval(musicInterval);musicInterval=setInterval(()=>{if(!running||paused)return;beep(220,0.12,'square',0.04);setTimeout(()=>beep(330,0.12,'square',0.04),120);setTimeout(()=>beep(440,0.12,'square',0.04),240);},400);}
function stopBackgroundMusic(){if(musicInterval)clearInterval(musicInterval);}

// Visual feedback for hits
function flashHit() {
  hitFlash.style.opacity = '1';
  setTimeout(() => {
    hitFlash.style.opacity = '0';
  }, 100);
}

// â”€â”€ ENEMIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helper to get spawn range (avoid edges on mobile)
function getSpawnX() {
  if (isMobile) {
    const margin = canvas.width * MOBILE_EDGE_MARGIN;
    return margin + Math.random() * (canvas.width - 2 * margin);
  }
  return Math.random() * (canvas.width * 0.8) + canvas.width * 0.1;
}

class Snack{
  constructor(){
    this.x = getSpawnX();
    this.y = -40;
    this.baseSpeed = 2 + level * 0.5;
    this.speed = this.baseSpeed * (isMobile ? MOBILE_SPEED_MULT : 1);
    this.baseSize = 25;
    this.size = this.baseSize * (isMobile ? MOBILE_SIZE_MULT : 1);
    this.wobble = Math.random() * Math.PI * 2;
    this.type = 'snack';
    this.points = 1;
  }
  update(){
    this.y += this.speed;
    this.wobble += 0.1;
    this.x += Math.sin(this.wobble) * 0.5;
  }
  draw(){
    ctx.fillStyle='#ffcc66';
    ctx.strokeStyle='#ff9933';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();
  }
  isOffScreen(){
    return this.y > canvas.height + 50;
  }
}

class Alien{
  constructor(){
    this.x = getSpawnX();
    this.y = -40;
    this.baseSpeed = 2.5 + level * 0.6;
    this.speed = this.baseSpeed * (isMobile ? MOBILE_SPEED_MULT : 1);
    this.baseSize = 30;
    this.size = this.baseSize * (isMobile ? MOBILE_SIZE_MULT : 1);
    this.wobble = 0;
    this.type = 'alien';
    this.points = 2;
  }
  update(){
    this.y += this.speed;
    this.wobble += 0.15;
    this.x += Math.sin(this.wobble) * 1.5;
  }
  draw(){
    ctx.fillStyle='#9d4edd';
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle='#fff';
    ctx.beginPath();
    const eyeOffset = this.size * 0.27;
    const eyeSize = this.size * 0.2;
    ctx.arc(this.x - eyeOffset, this.y - this.size*0.17, eyeSize, 0, Math.PI*2);
    ctx.arc(this.x + eyeOffset, this.y - this.size*0.17, eyeSize, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle='#000';
    ctx.beginPath();
    const pupilSize = this.size * 0.1;
    ctx.arc(this.x - eyeOffset, this.y - this.size*0.17, pupilSize, 0, Math.PI*2);
    ctx.arc(this.x + eyeOffset, this.y - this.size*0.17, pupilSize, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle='#7209b7';
    ctx.lineWidth=2;
    ctx.beginPath();
    const antennaX = this.size * 0.33;
    const antennaH = this.size * 0.33;
    ctx.moveTo(this.x - antennaX, this.y - this.size);
    ctx.lineTo(this.x - antennaX, this.y - this.size - antennaH);
    ctx.moveTo(this.x + antennaX, this.y - this.size);
    ctx.lineTo(this.x + antennaX, this.y - this.size - antennaH);
    ctx.stroke();
    ctx.fillStyle='#f72585';
    ctx.beginPath();
    const bulbSize = this.size * 0.1;
    ctx.arc(this.x - antennaX, this.y - this.size - antennaH, bulbSize, 0, Math.PI*2);
    ctx.arc(this.x + antennaX, this.y - this.size - antennaH, bulbSize, 0, Math.PI*2);
    ctx.fill();
  }
  isOffScreen(){
    return this.y > canvas.height + 50;
  }
}

class Football{
  constructor(){
    this.x = getSpawnX();
    this.y = -50;
    this.baseSpeed = 3 + level * 0.7;
    this.speed = this.baseSpeed * (isMobile ? MOBILE_SPEED_MULT : 1);
    this.baseSize = 28;
    this.size = this.baseSize * (isMobile ? MOBILE_SIZE_MULT : 1);
    this.rotation = 0;
    this.type = 'football';
    this.points = 3;
  }
  update(){
    this.y += this.speed;
    this.rotation += 0.2;
  }
  draw(){
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation);
    ctx.fillStyle='#8b4513';
    ctx.beginPath();
    ctx.ellipse(0, 0, this.size, this.size*0.6, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle='#fff';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(0, -this.size*0.5);
    ctx.lineTo(0, this.size*0.5);
    ctx.stroke();
    for(let i=-3; i<=3; i++){
      ctx.beginPath();
      ctx.moveTo(-5, i*6);
      ctx.lineTo(5, i*6);
      ctx.stroke();
    }
    ctx.restore();
  }
  isOffScreen(){
    return this.y > canvas.height + 50;
  }
}

class UFO{
  constructor(){
    this.x = getSpawnX();
    this.y = -60;
    this.baseSpeed = 1.8 + level * 0.4;
    this.speed = this.baseSpeed * (isMobile ? MOBILE_SPEED_MULT : 1);
    this.baseSize = 35;
    this.size = this.baseSize * (isMobile ? MOBILE_SIZE_MULT : 1);
    this.wobble = Math.random() * Math.PI * 2;
    this.type = 'ufo';
    this.points = 5;
  }
  update(){
    this.y += this.speed;
    this.wobble += 0.08;
    this.x += Math.sin(this.wobble) * 2;
  }
  draw(){
    ctx.fillStyle='#00d9ff';
    ctx.beginPath();
    ctx.arc(this.x, this.y - 10, this.size*0.5, 0, Math.PI, true);
    ctx.fill();
    ctx.fillStyle='#00a8cc';
    ctx.beginPath();
    ctx.ellipse(this.x, this.y, this.size, this.size*0.4, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle='#ffff00';
    const lightSpacing = this.size * 0.43;
    for(let i=-1; i<=1; i++){
      ctx.beginPath();
      ctx.arc(this.x + i*lightSpacing, this.y + 5, 4, 0, Math.PI*2);
      ctx.fill();
    }
  }
  isOffScreen(){
    return this.y > canvas.height + 50;
  }
}

class Drone{
  constructor(){
    this.x = getSpawnX();
    this.y = -50;
    this.baseSpeed = 2.2 + level * 0.45;
    this.speed = this.baseSpeed * (isMobile ? MOBILE_SPEED_MULT : 1);
    this.baseSize = 28;
    this.size = this.baseSize * (isMobile ? MOBILE_SIZE_MULT : 1);
    this.angle = 0;
    this.type = 'drone';
    this.points = 4;
  }
  update(){
    this.y += this.speed;
    this.angle += 0.12;
    this.x += Math.cos(this.angle) * 2;
  }
  draw(){
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.angle);
    ctx.fillStyle='#888';
    const bodySize = this.size;
    ctx.fillRect(-bodySize/2, -bodySize/2, bodySize, bodySize);
    ctx.fillStyle='#ff4444';
    ctx.beginPath();
    ctx.arc(0, 0, bodySize*0.29, 0, Math.PI*2);
    ctx.fill();
    for(let i=0; i<4; i++){
      ctx.save();
      ctx.rotate(i * Math.PI / 2);
      ctx.fillStyle='#555';
      ctx.fillRect(bodySize/2, -bodySize*0.11, bodySize*0.36, bodySize*0.21);
      ctx.restore();
    }
    ctx.restore();
  }
  isOffScreen(){
    return this.y > canvas.height + 50;
  }
}

class Demon{
  constructor(){
    this.x = getSpawnX();
    this.y = -70;
    this.baseSpeed = 1.5 + level * 0.3;
    this.speed = this.baseSpeed * (isMobile ? MOBILE_SPEED_MULT : 1);
    this.baseSize = 40;
    this.size = this.baseSize * (isMobile ? MOBILE_SIZE_MULT : 1);
    this.wobble = Math.random() * Math.PI * 2;
    this.type = 'demon';
    this.points = 7;
  }
  update(){
    this.y += this.speed;
    this.wobble += 0.05;
    this.x += Math.sin(this.wobble * 0.7) * 3;
  }
  draw(){
    ctx.fillStyle='#cc0000';
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
    ctx.fill();
    // Horns
    ctx.fillStyle='#ff6600';
    const hornBase = this.size * 0.38;
    const hornTip = this.size * 0.75;
    ctx.beginPath();
    ctx.moveTo(this.x - this.size, this.y - 10);
    ctx.lineTo(this.x - this.size - hornBase, this.y - hornTip);
    ctx.lineTo(this.x - this.size + 10, this.y - 5);
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(this.x + this.size, this.y - 10);
    ctx.lineTo(this.x + this.size + hornBase, this.y - hornTip);
    ctx.lineTo(this.x + this.size - 10, this.y - 5);
    ctx.fill();
    // Eyes
    ctx.fillStyle='#ffff00';
    const eyeOffset = this.size * 0.3;
    const eyeSize = this.size * 0.18;
    ctx.beginPath();
    ctx.arc(this.x - eyeOffset, this.y - 8, eyeSize, 0, Math.PI*2);
    ctx.arc(this.x + eyeOffset, this.y - 8, eyeSize, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle='#000';
    const pupilSize = this.size * 0.1;
    ctx.beginPath();
    ctx.arc(this.x - eyeOffset, this.y - 8, pupilSize, 0, Math.PI*2);
    ctx.arc(this.x + eyeOffset, this.y - 8, pupilSize, 0, Math.PI*2);
    ctx.fill();
    // Smile
    ctx.strokeStyle='#ff0000';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.arc(this.x, this.y + 10, this.size*0.3, 0.2, Math.PI - 0.2);
    ctx.stroke();
  }
  isOffScreen(){
    return this.y > canvas.height + 80;
  }
}

class Phantom{
  constructor(){
    this.x = getSpawnX();
    this.y = -80;
    this.baseSpeed = 1.2 + level * 0.2;
    this.speed = this.baseSpeed * (isMobile ? MOBILE_SPEED_MULT : 1);
    this.baseSize = 45;
    this.size = this.baseSize * (isMobile ? MOBILE_SIZE_MULT : 1);
    this.wobble = Math.random() * Math.PI * 2;
    this.alpha = 0.6 + Math.random() * 0.4;
    this.type = 'phantom';
    this.points = 10;
  }
  update(){
    this.y += this.speed;
    this.wobble += 0.04;
    this.x += Math.sin(this.wobble * 0.5) * 4;
    this.alpha = 0.4 + Math.abs(Math.sin(this.wobble * 2)) * 0.6;
  }
  draw(){
    ctx.save();
    ctx.globalAlpha = this.alpha;
    ctx.fillStyle='#7700ff';
    ctx.beginPath();
    ctx.arc(this.x, this.y - 10, this.size*0.6, Math.PI, 0);
    ctx.lineTo(this.x + this.size*0.6, this.y + 10);
    for(let i=3; i>=0; i--){
      const px = this.x + this.size*0.6 - (i+1)*(this.size*1.2/4);
      const py = this.y + 10 + (i%2===0 ? 12 : -4);
      ctx.lineTo(px, py);
    }
    ctx.lineTo(this.x - this.size*0.6, this.y + 10);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.8)';
    const eyeOffset = this.size * 0.27;
    const eyeSize = this.size * 0.13;
    ctx.beginPath();
    ctx.arc(this.x - eyeOffset, this.y - 8, eyeSize, 0, Math.PI*2);
    ctx.arc(this.x + eyeOffset, this.y - 8, eyeSize, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
    ctx.globalAlpha = 1;
  }
  isOffScreen(){
    return this.y > canvas.height + 90;
  }
}

class Boss{
  constructor(){
    this.x = canvas.width / 2;
    this.y = -120;
    this.hp = 10 + level * 3;
    this.maxHp = this.hp;
    this.baseSize = 80;
    this.size = this.baseSize * (isMobile ? MOBILE_SIZE_MULT : 1);
    this.baseSpeed = 1.2;
    this.speed = this.baseSpeed * (isMobile ? MOBILE_SPEED_MULT : 1);
    this.type = 'boss';
  }
  update(){
    this.y += this.speed;
    this.x += Math.sin(this.y * 0.02) * 2;
  }
  draw(){
    if(!isMobile){
      ctx.shadowBlur = 20;
      ctx.shadowColor = '#00ff00';
    }
    ctx.fillStyle='#7cff7c';
    ctx.strokeStyle='#00cc00';
    ctx.lineWidth = 4;
    ctx.fillRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size);
    ctx.strokeRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size);
    if(!isMobile) ctx.shadowBlur = 0;
    
    ctx.fillStyle='#ff0000';
    const eyeOffset = this.size * 0.19;
    const eyeSize = this.size * 0.1;
    ctx.beginPath();
    ctx.arc(this.x - eyeOffset, this.y - 10, eyeSize, 0, Math.PI*2);
    ctx.arc(this.x + eyeOffset, this.y - 10, eyeSize, 0, Math.PI*2);
    ctx.fill();
    
    ctx.fillStyle='#000';
    ctx.font = `bold ${this.size*0.25}px Arial`;
    ctx.textAlign='center';
    ctx.fillText('BOSS', this.x, this.y + 10);
    
    // Health bar
    const bw = this.size;
    const bh = 8;
    const bx = this.x - bw/2;
    const by = this.y - this.size/2 - 20;
    ctx.fillStyle='#ff0000';
    ctx.fillRect(bx, by, bw, bh);
    ctx.fillStyle='#00ff00';
    ctx.fillRect(bx, by, bw * (this.hp / this.maxHp), bh);
    ctx.strokeStyle='#000';
    ctx.lineWidth = 2;
    ctx.strokeRect(bx, by, bw, bh);
    ctx.textAlign='left';
  }
  isOffScreen(){
    return this.y > canvas.height + 150;
  }
}

function spawn(){
  if(!running || paused) return;
  if(level % 5 === 0 && !boss){
    boss = new Boss();
    playBoss();
    return;
  }
  const r = Math.random();
  if(level >= 60 && r < 0.12) enemies.push(new Phantom());
  else if(level >= 40 && r < 0.20) enemies.push(new Demon());
  else if(level >= 20 && r < 0.28) enemies.push(new Drone());
  else if(level >= 10 && r < 0.40) enemies.push(new UFO());
  else if(level >= 7 && r < 0.55) enemies.push(new Football());
  else if(level >= 3 && r < 0.72) enemies.push(new Alien());
  else enemies.push(new Snack());
}

// â”€â”€ HIT / LEVEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function registerHit(){
  sessionHits++;
  enemiesHitCount++;
  shotsHit++;
  allTimeHits++;
  
  // Enhanced visual feedback on mobile
  if (isMobile) {
    flashHit();
  }
  
  const newLevel = getLevelForHits(sessionHits);
  if(newLevel > level){
    level = newLevel;
    playLevelUp();
    showLevelUpBanner(level);
  }
  checkAndUnlockWeapons();
  saveProgress();
  updateUI();
}

function showLevelUpBanner(lv){
  const b = document.getElementById('levelUpBanner');
  b.textContent = `ðŸŽ‰ LEVEL ${lv}!`;
  b.style.display = 'block';
  setTimeout(() => {
    b.style.display = 'none';
  }, 1500);
}

function updateUI(){
  document.getElementById('hitsDisplay').textContent = sessionHits;
  document.getElementById('level').textContent = level;
  document.getElementById('bestHitsDisplay').textContent = allTimeHits;
  const next = getNextStep(sessionHits);
  document.getElementById('nextLevelInfo').textContent = next ? `Lvl ${next.level} in ${next.hits - sessionHits}` : 'MAX!';
}

// Aim assist for mobile
function applyAimAssist(x, y) {
  if (!isMobile) return { x, y };
  
  const assistRadius = 50; // Increased for mobile
  let closestDist = Infinity;
  let closestTarget = null;
  
  for (const e of enemies) {
    const dist = Math.hypot(x - e.x, y - e.y);
    if (dist < assistRadius + e.size && dist < closestDist) {
      closestDist = dist;
      closestTarget = e;
    }
  }
  
  if (boss) {
    const distToBoss = Math.min(
      Math.hypot(x - boss.x, y - boss.y),
      Math.abs(x - boss.x) + Math.abs(y - boss.y)
    );
    if (distToBoss < assistRadius + boss.size && distToBoss < closestDist) {
      closestTarget = boss;
    }
  }
  
  if (closestTarget) {
    const pullStrength = 0.35; // Slightly stronger for mobile
    return {
      x: x + (closestTarget.x - x) * pullStrength,
      y: y + (closestTarget.y - y) * pullStrength
    };
  }
  
  return { x, y };
}

function checkHit(x, y, radius=0){
  const adjusted = applyAimAssist(x, y);
  x = adjusted.x;
  y = adjusted.y;
  
  for(let i = enemies.length - 1; i >= 0; i--){
    const e = enemies[i];
    if(Math.hypot(x - e.x, y - e.y) < e.size + radius){
      score += e.points;
      playHit();
      enemies.splice(i, 1);
      registerHit();
      return true;
    }
  }
  
  if(boss){
    const inB = x >= boss.x - boss.size/2 - radius && 
                x <= boss.x + boss.size/2 + radius && 
                y >= boss.y - boss.size/2 - radius && 
                y <= boss.y + boss.size/2 + radius;
    if(inB){
      boss.hp--;
      playHit();
      if(boss.hp <= 0){
        score += 20;
        bossesDefeatedCount++;
        playLevelUp();
        boss = null;
      }
      registerHit();
      return true;
    }
  }
  return false;
}

// â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleClick(x, y){
  if(!running || paused) return;
  gunRecoil = 20;
  muzzleFlash = 10;
  shotsFired++;
  let hit = false;
  
  if(blaster==='pistol'){playShoot();hit=checkHit(x,y);}
  else if(blaster==='revolver'){playRevolverShoot();hit=checkHit(x,y,5);}
  else if(blaster==='shotgun'){playSpreadShoot();hit=checkHit(x,y)||checkHit(x-30,y-30)||checkHit(x+30,y-30)||checkHit(x-30,y+30)||checkHit(x+30,y+30);}
  else if(blaster==='uzi'){playUziShoot();hit=checkHit(x,y);}
  else if(blaster==='rifle'){playRapidShoot();hit=checkHit(x,y);}
  else if(blaster==='sniper'){playSniperShoot();hit=checkHit(x,y,15);}
  else if(blaster==='minigun'){playMinigunShoot();hit=checkHit(x,y);}
  else if(blaster==='railgun'){playRailgunShoot();hit=checkHit(x,y,20);}
  else if(blaster==='plasma'){playPlasmaShoot();hit=checkHit(x,y,10);}
  else if(blaster==='laser'){playLaserShoot();hit=checkHit(x,y,8);}
  else if(blaster==='vortex'){playVortexShoot();hit=checkHit(x,y,12)||checkHit(x-25,y)||checkHit(x+25,y)||checkHit(x,y-25)||checkHit(x,y+25);}
  else if(blaster==='thunder'){playThunderShoot();hit=checkHit(x,y,18);}
  else if(blaster==='cryo'){playCryoShoot();hit=checkHit(x,y)||checkHit(x-20,y-20)||checkHit(x+20,y-20)||checkHit(x-20,y+20)||checkHit(x+20,y+20)||checkHit(x-35,y)||checkHit(x+35,y);}
  else if(blaster==='inferno'){playInfernoShoot();hit=checkHit(x,y,15)||checkHit(x+(Math.random()-0.5)*60,y+(Math.random()-0.5)*60,10);}
  else if(blaster==='gravity'){playGravityShoot();hit=checkHit(x,y,30);}
  else if(blaster==='quantum'){playQuantumShoot();hit=checkHit(x,y,10)||checkHit(x-(Math.random()*80-40),y-(Math.random()*80-40),5);}
  else if(blaster==='void'){playVoidShoot();hit=checkHit(x,y,25)||checkHit(x-40,y,8)||checkHit(x+40,y,8)||checkHit(x,y-40,8)||checkHit(x,y+40,8);}
  else if(blaster==='nova'){playNovaShoot();for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2;hit=checkHit(x+Math.cos(a)*35,y+Math.sin(a)*35,8)||hit;}hit=checkHit(x,y,20)||hit;}
  else if(blaster==='omega'){playOmegaShoot();hit=checkHit(x,y,20)||checkHit(x-50,y,12)||checkHit(x+50,y,12)||checkHit(x,y-50,12)||checkHit(x,y+50,12)||checkHit(x-35,y-35,8)||checkHit(x+35,y-35,8)||checkHit(x-35,y+35,8)||checkHit(x+35,y+35,8);}
  else if(blaster==='celestialbeam'){playCelestialbeamShoot();
    for(let i=enemies.length-1;i>=0;i--){
      if(Math.abs(enemies[i].x-x)<60){
        score+=enemies[i].points;
        playHit();
        enemies.splice(i,1);
        registerHit();
        hit=true;
      }
    }
    if(boss&&Math.abs(boss.x-x)<80){
      boss.hp-=3;
      playHit();
      if(boss.hp<=0){
        score+=20;
        bossesDefeatedCount++;
        playLevelUp();
        boss=null;
      }
      registerHit();
      hit=true;
    }
  }

  if(!hit){
    missedShots++;
    if(missedShots >= 10){
      document.getElementById('missedWarning').style.display = 'block';
      setTimeout(() => {
        document.getElementById('missedWarning').style.display = 'none';
      }, 1000);
      setTimeout(() => endGame(), 1000);
    }
  }
  
  const acc = shotsFired > 0 ? Math.round((shotsHit / shotsFired) * 100) : 100;
  document.getElementById('accuracy').textContent = acc;
  document.getElementById('misses').textContent = missedShots;
}

let rapidFireTimeout = null;
let isShootingMobile = false;

// Desktop mouse events
if (!isMobile) {
  canvas.addEventListener('click', e => {
    const r = canvas.getBoundingClientRect();
    handleClick(e.clientX - r.left, e.clientY - r.top);
  });
  
  canvas.addEventListener('mousedown', e => {
    if(!['rifle','uzi','minigun','laser','vortex','thunder','omega','celestialbeam'].includes(blaster)) return;
    
    const fireRapid = () => {
      if(!running || paused) return;
      gunRecoil = 10;
      muzzleFlash = 5;
      shotsFired++;
      
      if(blaster==='rifle')playRapidShoot();
      else if(blaster==='uzi')playUziShoot();
      else if(blaster==='minigun')playMinigunShoot();
      else if(blaster==='laser')playLaserShoot();
      else if(blaster==='vortex')playVortexShoot();
      else if(blaster==='thunder')playThunderShoot();
      else if(blaster==='omega')playOmegaShoot();
      else if(blaster==='celestialbeam')playCelestialbeamShoot();
      
      let hit = false;
      if(blaster==='laser')hit=checkHit(mouseX,mouseY,8);
      else if(blaster==='vortex')hit=checkHit(mouseX,mouseY,12)||checkHit(mouseX-25,mouseY)||checkHit(mouseX+25,mouseY);
      else if(blaster==='thunder')hit=checkHit(mouseX,mouseY,18);
      else if(blaster==='omega')hit=checkHit(mouseX,mouseY,20)||checkHit(mouseX-50,mouseY,12)||checkHit(mouseX+50,mouseY,12);
      else if(blaster==='celestialbeam'){
        for(let i=enemies.length-1;i>=0;i--){
          if(Math.abs(enemies[i].x-mouseX)<60){
            score+=enemies[i].points;
            enemies.splice(i,1);
            registerHit();
            hit=true;
          }
        }
        if(boss&&Math.abs(boss.x-mouseX)<80){
          boss.hp-=3;
          if(boss.hp<=0){
            score+=20;
            bossesDefeatedCount++;
            playLevelUp();
            boss=null;
          }
          registerHit();
          hit=true;
        }
      }
      else hit=checkHit(mouseX,mouseY);
      
      if(!hit){
        missedShots++;
        if(missedShots>=10){
          document.getElementById('missedWarning').style.display='block';
          setTimeout(()=>{document.getElementById('missedWarning').style.display='none';},1000);
          setTimeout(()=>endGame(),1000);
        }
      }
      
      const acc=shotsFired>0?Math.round((shotsHit/shotsFired)*100):100;
      document.getElementById('accuracy').textContent=acc;
      document.getElementById('misses').textContent=missedShots;
    };
    
    const rate=blaster==='celestialbeam'?20:blaster==='minigun'?50:blaster==='uzi'?80:blaster==='vortex'?70:blaster==='thunder'?90:blaster==='omega'?110:blaster==='laser'?30:100;
    rapidFireTimeout=setInterval(fireRapid,rate);
  });
  
  canvas.addEventListener('mouseup', () => {
    if(rapidFireTimeout){
      clearInterval(rapidFireTimeout);
      rapidFireTimeout = null;
    }
  });
  
  canvas.addEventListener('mousemove', e => {
    const r = canvas.getBoundingClientRect();
    mouseX = e.clientX - r.left;
    mouseY = e.clientY - r.top;
  });
}

// Mobile touch events for aiming (drag anywhere on canvas)
canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  const r = canvas.getBoundingClientRect();
  const t = e.touches[0];
  mouseX = t.clientX - r.left;
  mouseY = t.clientY - r.top;
}, {passive: false});

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  const r = canvas.getBoundingClientRect();
  const t = e.touches[0];
  mouseX = t.clientX - r.left;
  mouseY = t.clientY - r.top;
}, {passive: false});

// Mobile shoot button
shootButton.addEventListener('touchstart', e => {
  e.preventDefault();
  if (!running || paused) return;
  
  isShootingMobile = true;
  
  // Single shot weapons
  if (!['rifle','uzi','minigun','laser','vortex','thunder','omega','celestialbeam'].includes(blaster)) {
    handleClick(mouseX, mouseY);
  } else {
    // Auto-fire weapons
    const fireRapid = () => {
      if (!running || paused || !isShootingMobile) return;
      gunRecoil = 10;
      muzzleFlash = 5;
      shotsFired++;
      
      if(blaster==='rifle')playRapidShoot();
      else if(blaster==='uzi')playUziShoot();
      else if(blaster==='minigun')playMinigunShoot();
      else if(blaster==='laser')playLaserShoot();
      else if(blaster==='vortex')playVortexShoot();
      else if(blaster==='thunder')playThunderShoot();
      else if(blaster==='omega')playOmegaShoot();
      else if(blaster==='celestialbeam')playCelestialbeamShoot();
      
      let hit = false;
      if(blaster==='laser')hit=checkHit(mouseX,mouseY,8);
      else if(blaster==='vortex')hit=checkHit(mouseX,mouseY,12)||checkHit(mouseX-25,mouseY)||checkHit(mouseX+25,mouseY);
      else if(blaster==='thunder')hit=checkHit(mouseX,mouseY,18);
      else if(blaster==='omega')hit=checkHit(mouseX,mouseY,20)||checkHit(mouseX-50,mouseY,12)||checkHit(mouseX+50,mouseY,12);
      else if(blaster==='celestialbeam'){
        for(let i=enemies.length-1;i>=0;i--){
          if(Math.abs(enemies[i].x-mouseX)<60){
            score+=enemies[i].points;
            enemies.splice(i,1);
            registerHit();
            hit=true;
          }
        }
        if(boss&&Math.abs(boss.x-mouseX)<80){
          boss.hp-=3;
          if(boss.hp<=0){
            score+=20;
            bossesDefeatedCount++;
            playLevelUp();
            boss=null;
          }
          registerHit();
          hit=true;
        }
      }
      else hit=checkHit(mouseX,mouseY);
      
      if(!hit){
        missedShots++;
        if(missedShots>=10){
          document.getElementById('missedWarning').style.display='block';
          setTimeout(()=>{document.getElementById('missedWarning').style.display='none';},1000);
          setTimeout(()=>endGame(),1000);
        }
      }
      
      const acc=shotsFired>0?Math.round((shotsHit/shotsFired)*100):100;
      document.getElementById('accuracy').textContent=acc;
      document.getElementById('misses').textContent=missedShots;
    };
    
    const rate=blaster==='celestialbeam'?20:blaster==='minigun'?50:blaster==='uzi'?80:blaster==='vortex'?70:blaster==='thunder'?90:blaster==='omega'?110:blaster==='laser'?30:100;
    rapidFireTimeout=setInterval(fireRapid,rate);
  }
}, {passive: false});

shootButton.addEventListener('touchend', e => {
  e.preventDefault();
  isShootingMobile = false;
  if (rapidFireTimeout) {
    clearInterval(rapidFireTimeout);
    rapidFireTimeout = null;
  }
}, {passive: false});

shootButton.addEventListener('touchcancel', e => {
  e.preventDefault();
  isShootingMobile = false;
  if (rapidFireTimeout) {
    clearInterval(rapidFireTimeout);
    rapidFireTimeout = null;
  }
}, {passive: false});

document.addEventListener('keydown', e => {
  if(e.code === 'Space' && running){
    e.preventDefault();
    paused = !paused;
    document.getElementById('pauseOverlay').style.display = paused ? 'block' : 'none';
  }
});

document.getElementById('mapSelect').onchange = e => map = e.target.value;
document.getElementById('crosshairSelect').onchange = e => crosshair = e.target.value;

// â”€â”€ BACKGROUNDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawBackground(){
  cyberTime += 0.016;
  nebulaTime.t += 0.008;
  
  const useShadow = !isMobile;

  if(map==='sky'){
    const g=ctx.createLinearGradient(0,0,0,canvas.height);g.addColorStop(0,'#87CEEB');g.addColorStop(1,'#e0f6ff');ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='rgba(255,255,255,0.6)';for(let i=0;i<5;i++){const x=(Date.now()*0.01+i*200)%(canvas.width+200);ctx.beginPath();ctx.arc(x,100+i*50,40,0,Math.PI*2);ctx.arc(x+30,100+i*50,50,0,Math.PI*2);ctx.arc(x+60,100+i*50,40,0,Math.PI*2);ctx.fill();}
  } else if(map==='night'){
    const g=ctx.createLinearGradient(0,0,0,canvas.height);g.addColorStop(0,'#0b132b');g.addColorStop(1,'#1c2541');ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#f4f4f4';ctx.beginPath();ctx.arc(canvas.width-150,100,50,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fff';for(let i=0;i<100;i++)ctx.fillRect((i*137.5)%canvas.width,(i*47.3)%(canvas.height*0.6),2,2);
  } else if(map==='sunset'){
    const g=ctx.createLinearGradient(0,0,0,canvas.height);g.addColorStop(0,'#ff9966');g.addColorStop(0.5,'#ff6b9d');g.addColorStop(1,'#330033');ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#ff6347';if(useShadow){ctx.shadowBlur=50;ctx.shadowColor='#ff4500';}ctx.beginPath();ctx.arc(canvas.width/2,canvas.height*0.3,80,0,Math.PI*2);ctx.fill();if(useShadow)ctx.shadowBlur=0;
  } else if(map==='space'){
    const g=ctx.createRadialGradient(canvas.width/2,canvas.height/2,0,canvas.width/2,canvas.height/2,canvas.width);g.addColorStop(0,'#1a0033');g.addColorStop(0.5,'#0d001a');g.addColorStop(1,'#000000');ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);
    stars.forEach(s=>{ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(s.x,s.y,s.size,0,Math.PI*2);ctx.fill();s.x+=s.speed;if(s.x>canvas.width)s.x=0;});
    ctx.fillStyle='rgba(138,43,226,0.1)';ctx.beginPath();ctx.arc(canvas.width*0.3,canvas.height*0.4,200,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,0,128,0.08)';ctx.beginPath();ctx.arc(canvas.width*0.7,canvas.height*0.6,250,0,Math.PI*2);ctx.fill();
  } else if(map==='forest'){
    const g=ctx.createLinearGradient(0,0,0,canvas.height);g.addColorStop(0,'#87a96b');g.addColorStop(1,'#c9e4ca');ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);
    for(let i=0;i<12;i++){const x=i*(canvas.width/11),h=200+Math.sin(i)*50;ctx.fillStyle='#654321';ctx.fillRect(x-15,canvas.height-h,30,h);ctx.fillStyle='#2d5016';ctx.beginPath();ctx.moveTo(x,canvas.height-h-80);ctx.lineTo(x-60,canvas.height-h+20);ctx.lineTo(x+60,canvas.height-h+20);ctx.fill();ctx.beginPath();ctx.moveTo(x,canvas.height-h-50);ctx.lineTo(x-50,canvas.height-h);ctx.lineTo(x+50,canvas.height-h);ctx.fill();}
  } else if(map==='ocean'){
    const g1=ctx.createLinearGradient(0,0,0,canvas.height*0.5);g1.addColorStop(0,'#87CEEB');g1.addColorStop(1,'#4FC3F7');ctx.fillStyle=g1;ctx.fillRect(0,0,canvas.width,canvas.height*0.5);
    const g2=ctx.createLinearGradient(0,canvas.height*0.5,0,canvas.height);g2.addColorStop(0,'#006994');g2.addColorStop(1,'#003d5c');ctx.fillStyle=g2;ctx.fillRect(0,canvas.height*0.5,canvas.width,canvas.height*0.5);
    ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=2;for(let i=0;i<5;i++){const off=(Date.now()*0.001+i*0.5)%2;ctx.beginPath();for(let x=0;x<canvas.width;x+=20)ctx.lineTo(x,canvas.height*0.5+i*80+Math.sin(x*0.02+off*Math.PI)*15);ctx.stroke();}
  } else if(map==='desert'){
    const g1=ctx.createLinearGradient(0,0,0,canvas.height*0.6);g1.addColorStop(0,'#f4c430');g1.addColorStop(1,'#f0e68c');ctx.fillStyle=g1;ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#c2b280';ctx.beginPath();ctx.moveTo(0,canvas.height);for(let x=0;x<=canvas.width;x+=100)ctx.lineTo(x,canvas.height-150+Math.sin(x*0.01)*50);ctx.lineTo(canvas.width,canvas.height);ctx.fill();
    ctx.fillStyle='#d2b48c';ctx.beginPath();ctx.moveTo(0,canvas.height);for(let x=0;x<=canvas.width;x+=80)ctx.lineTo(x,canvas.height-80+Math.cos(x*0.015)*40);ctx.lineTo(canvas.width,canvas.height);ctx.fill();
    for(let i=0;i<6;i++){const x=100+i*180,y=canvas.height-100;ctx.fillStyle='#2d5016';ctx.fillRect(x-10,y-60,20,60);ctx.fillRect(x-25,y-40,15,30);ctx.fillRect(x+10,y-50,15,35);}
  } else if(map==='grid'){
    ctx.fillStyle='#000';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.strokeStyle='#0f0';ctx.lineWidth=1;
    for(let x=0;x<canvas.width;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
    for(let y=0;y<canvas.height;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
  } else if(map==='neonCyber'){
    ctx.fillStyle='#010008';ctx.fillRect(0,0,canvas.width,canvas.height);
    const horizon=canvas.height*0.55,vp=canvas.width/2;
    const gc1=`rgba(0,255,255,${0.35+Math.sin(cyberTime*1.2)*0.12})`;
    ctx.lineWidth=1;
    for(let i=-18;i<=18;i++){ctx.strokeStyle=i%3===0?gc1:`rgba(0,180,255,0.18)`;ctx.beginPath();ctx.moveTo(vp+i*(canvas.width/16),canvas.height);ctx.lineTo(vp,horizon);ctx.stroke();}
    for(let j=0;j<18;j++){const t=j/18;const scrollY=((cyberTime*0.4)%(1/18))*18;const yy=horizon+(canvas.height-horizon)*(((j/18)+scrollY*(1/18))%1)**2;const alpha=0.1+t*0.4;ctx.strokeStyle=j%4===0?`rgba(255,0,255,${alpha})`:`rgba(0,255,255,${alpha*0.6})`;ctx.lineWidth=j%4===0?1.5:0.8;const lx=vp-(vp)*t*t*2.5;const rx=vp+(vp)*t*t*2.5;ctx.beginPath();ctx.moveTo(Math.max(0,lx),yy);ctx.lineTo(Math.min(canvas.width,rx),yy);ctx.stroke();}
    const hg=ctx.createLinearGradient(0,horizon,canvas.width,horizon);hg.addColorStop(0,'rgba(0,0,0,0)');hg.addColorStop(0.3,'rgba(255,0,255,0.9)');hg.addColorStop(0.5,'rgba(0,255,255,1)');hg.addColorStop(0.7,'rgba(255,0,255,0.9)');hg.addColorStop(1,'rgba(0,0,0,0)');ctx.strokeStyle=hg;ctx.lineWidth=3;if(useShadow){ctx.shadowBlur=18;ctx.shadowColor='#ff00ff';}ctx.beginPath();ctx.moveTo(0,horizon);ctx.lineTo(canvas.width,horizon);ctx.stroke();if(useShadow)ctx.shadowBlur=0;
    cyberParticles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=canvas.width;if(p.x>canvas.width)p.x=0;if(p.y<0)p.y=canvas.height;if(p.y>canvas.height)p.y=0;if(useShadow){ctx.shadowBlur=10;ctx.shadowColor=`hsl(${p.hue},100%,60%)`;}ctx.fillStyle=`hsl(${p.hue},100%,70%)`;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();});if(useShadow)ctx.shadowBlur=0;
    for(let y=0;y<canvas.height;y+=4){ctx.fillStyle='rgba(0,0,0,0.08)';ctx.fillRect(0,y,canvas.width,2);}
    const topFade=ctx.createLinearGradient(0,0,0,horizon);topFade.addColorStop(0,'rgba(1,0,8,0.85)');topFade.addColorStop(1,'rgba(1,0,8,0)');ctx.fillStyle=topFade;ctx.fillRect(0,0,canvas.width,horizon);
  } else if(map==='retroCity'){
    const skyG=ctx.createLinearGradient(0,0,0,canvas.height*0.72);skyG.addColorStop(0,'#0d0019');skyG.addColorStop(0.4,'#2d004d');skyG.addColorStop(0.75,'#7b0070');skyG.addColorStop(1,'#ff2d55');ctx.fillStyle=skyG;ctx.fillRect(0,0,canvas.width,canvas.height);
    const groundG=ctx.createLinearGradient(0,canvas.height*0.72,0,canvas.height);groundG.addColorStop(0,'#1a001a');groundG.addColorStop(1,'#000');ctx.fillStyle=groundG;ctx.fillRect(0,canvas.height*0.72,canvas.width,canvas.height*0.28);
    const sunY=canvas.height*0.68,sunR=120;const sunGrad=ctx.createRadialGradient(canvas.width/2,sunY,0,canvas.width/2,sunY,sunR);sunGrad.addColorStop(0,'rgba(255,255,100,1)');sunGrad.addColorStop(0.3,'rgba(255,140,0,0.9)');sunGrad.addColorStop(0.7,'rgba(255,0,120,0.6)');sunGrad.addColorStop(1,'rgba(255,0,120,0)');ctx.fillStyle=sunGrad;ctx.beginPath();ctx.arc(canvas.width/2,sunY,sunR,0,Math.PI*2);ctx.fill();
    ctx.save();ctx.beginPath();ctx.arc(canvas.width/2,sunY,sunR,0,Math.PI*2);ctx.clip();for(let i=0;i<12;i++){const sy=sunY-sunR+i*(sunR*2/12);if(i%2===0){ctx.fillStyle='rgba(80,0,30,0.55)';ctx.fillRect(canvas.width/2-sunR,sy,sunR*2,sunR*2/12);}}ctx.restore();
    ctx.fillStyle='rgba(255,255,255,0.7)';for(let i=0;i<80;i++){const sx=(i*173.3)%canvas.width,sy=(i*59.7)%(canvas.height*0.55);ctx.globalAlpha=0.4+Math.sin(cyberTime*2+i)*0.3;ctx.fillRect(sx,sy,1.5,1.5);}ctx.globalAlpha=1;
    cityBuildings.forEach((b,idx)=>{const bx=b.x+(Date.now()*0.008)%(canvas.width+200)-100;const by=canvas.height*0.72-b.h;ctx.fillStyle='#0a0010';ctx.fillRect(bx,by,b.w,b.h);b.windows.forEach(w=>{if(w.lit){const flicker=Math.sin(cyberTime*3+idx+w.oy)>0.85;ctx.fillStyle=flicker?`rgba(255,180,255,0.1)`:`rgba(255,220,100,${0.5+Math.random()*0.3})`;ctx.fillRect(bx+w.ox,by+w.oy,8,6);}});});
    for(let i=0;i<10;i++){const bx=(i*(canvas.width/9)+cyberTime*15)%(canvas.width+120)-60;const bh=100+Math.sin(i*1.7)*80;const by=canvas.height*0.72-bh;const bw=50+Math.sin(i*2.3)*20;const hue=270+i*18;ctx.strokeStyle=`hsla(${hue},100%,65%,0.9)`;ctx.lineWidth=1.5;if(useShadow){ctx.shadowBlur=8;ctx.shadowColor=`hsl(${hue},100%,65%)`;}ctx.strokeRect(bx,by,bw,bh);if(useShadow)ctx.shadowBlur=0;ctx.beginPath();ctx.moveTo(bx+bw/2,by);ctx.lineTo(bx+bw/2,by-20);ctx.stroke();ctx.fillStyle=`hsl(${hue},100%,75%)`;ctx.beginPath();ctx.arc(bx+bw/2,by-22,3,0,Math.PI*2);ctx.fill();}
    const gHorizon=canvas.height*0.72;ctx.lineWidth=0.8;for(let i=-10;i<=10;i++){ctx.strokeStyle=`rgba(255,0,200,${0.3-Math.abs(i)*0.02})`;if(useShadow){ctx.shadowBlur=3;ctx.shadowColor='#ff00cc';}ctx.beginPath();ctx.moveTo(canvas.width/2+i*(canvas.width/10),canvas.height);ctx.lineTo(canvas.width/2,gHorizon);ctx.stroke();}for(let j=0;j<8;j++){const t=(j/8+((cyberTime*0.15)%1));const gy=gHorizon+(canvas.height-gHorizon)*t;ctx.strokeStyle=`rgba(255,0,200,${0.15+t*0.25})`;ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(canvas.width,gy);ctx.stroke();}if(useShadow)ctx.shadowBlur=0;
  } else if(map==='synthSpace'){
    const bg=ctx.createRadialGradient(canvas.width/2,canvas.height*0.4,0,canvas.width/2,canvas.height*0.4,canvas.width*0.9);bg.addColorStop(0,'#0a0020');bg.addColorStop(0.4,'#12003a');bg.addColorStop(0.8,'#05001a');bg.addColorStop(1,'#000000');ctx.fillStyle=bg;ctx.fillRect(0,0,canvas.width,canvas.height);
    const nebColors=[{h:290,s:'100%',l:'45%',ox:0.25,oy:0.3,r:0.35},{h:190,s:'100%',l:'40%',ox:0.75,oy:0.5,r:0.28},{h:320,s:'100%',l:'35%',ox:0.5,oy:0.65,r:0.3},{h:60,s:'80%',l:'40%',ox:0.15,oy:0.6,r:0.2}];
    nebColors.forEach((n,i)=>{const pulse=0.06+Math.sin(nebulaTime.t*0.7+i*1.4)*0.03;const nx=canvas.width*(n.ox+Math.sin(nebulaTime.t*0.3+i)*0.04);const ny=canvas.height*(n.oy+Math.cos(nebulaTime.t*0.25+i)*0.03);const nr=canvas.width*n.r;const ng=ctx.createRadialGradient(nx,ny,0,nx,ny,nr);ng.addColorStop(0,`hsla(${n.h},${n.s},${n.l},${pulse+0.04})`);ng.addColorStop(0.5,`hsla(${n.h},${n.s},${n.l},${pulse*0.5})`);ng.addColorStop(1,`hsla(${n.h},${n.s},${n.l},0)`);ctx.fillStyle=ng;ctx.fillRect(0,0,canvas.width,canvas.height);});
    for(let i=0;i<200;i++){const sx=(i*113.7+17)%canvas.width;const sy=(i*79.1+31)%canvas.height;const twinkle=0.4+Math.sin(nebulaTime.t*4+i*0.7)*0.4;const hue=180+Math.sin(i*0.3)*120;ctx.fillStyle=`hsla(${hue},60%,90%,${twinkle})`;const r=0.5+Math.sin(i*2.1)*0.5;ctx.beginPath();ctx.arc(sx,sy,r,0,Math.PI*2);ctx.fill();}
    const clusterSeeds=[[0.2,0.15],[0.8,0.25],[0.5,0.1],[0.1,0.7],[0.9,0.6]];clusterSeeds.forEach(([cx,cy],ci)=>{for(let k=0;k<12;k++){const sx=canvas.width*cx+(Math.sin(k*2.5+ci)*60);const sy=canvas.height*cy+(Math.cos(k*3.1+ci)*40);const hue=200+ci*40;if(useShadow){ctx.shadowBlur=8;ctx.shadowColor=`hsl(${hue},100%,70%)`;}ctx.fillStyle=`hsl(${hue},100%,85%)`;ctx.beginPath();ctx.arc(sx,sy,1.2,0,Math.PI*2);ctx.fill();}});if(useShadow)ctx.shadowBlur=0;
    const hg=ctx.createLinearGradient(0,canvas.height*0.7,0,canvas.height);hg.addColorStop(0,'rgba(255,0,200,0.2)');hg.addColorStop(0.3,'rgba(100,0,200,0.15)');hg.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=hg;ctx.fillRect(0,canvas.height*0.7,canvas.width,canvas.height*0.3);
    for(let r=0;r<4;r++){const rx=canvas.width*(0.2+r*0.22);const ry=canvas.height*(0.3+Math.sin(nebulaTime.t*0.5+r)*0.15);const rr=40+r*15+Math.sin(nebulaTime.t+r)*8;const rHue=260+r*30;ctx.strokeStyle=`hsla(${rHue},100%,65%,0.5)`;ctx.lineWidth=1.5;if(useShadow){ctx.shadowBlur=12;ctx.shadowColor=`hsl(${rHue},100%,65%)`;}ctx.beginPath();ctx.arc(rx,ry,rr,0,Math.PI*2);ctx.stroke();ctx.strokeStyle=`hsla(${rHue+40},100%,80%,0.3)`;ctx.lineWidth=0.8;ctx.beginPath();ctx.arc(rx,ry,rr*0.6,0,Math.PI*2);ctx.stroke();}if(useShadow)ctx.shadowBlur=0;
  } else if(map==='hyperspace'){
    ctx.fillStyle='#000005';ctx.fillRect(0,0,canvas.width,canvas.height);
    const cx=canvas.width/2,cy=canvas.height/2,maxDist=Math.hypot(cx,cy);
    warpStars.forEach(s=>{s.dist+=s.speed*(1+s.dist*1.8);if(s.dist>1.1){s.dist=Math.random()*0.05;s.angle=Math.random()*Math.PI*2;s.hue=Math.floor(Math.random()*360);s.speed=Math.random()*0.012+0.004;s.thickness=Math.random()*2+0.5;}const nearDist=(s.dist-s.speed*8)*maxDist;const farDist=s.dist*maxDist;const x1=cx+Math.cos(s.angle)*nearDist;const y1=cy+Math.sin(s.angle)*nearDist;const x2=cx+Math.cos(s.angle)*farDist;const y2=cy+Math.sin(s.angle)*farDist;const alpha=Math.min(1,s.dist*2.5);const hue=(s.hue+cyberTime*60)%360;ctx.strokeStyle=`hsla(${hue},${80+s.dist*20}%,70%,${alpha})`;ctx.lineWidth=s.thickness*s.dist*2;if(useShadow){ctx.shadowBlur=6;ctx.shadowColor=`hsl(${hue},100%,70%)`;}ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();});if(useShadow)ctx.shadowBlur=0;
    const vig=ctx.createRadialGradient(cx,cy,0,cx,cy,maxDist);vig.addColorStop(0,'rgba(0,0,10,0)');vig.addColorStop(0.5,'rgba(0,0,10,0)');vig.addColorStop(0.8,'rgba(0,0,10,0.35)');vig.addColorStop(1,'rgba(0,0,10,0.85)');ctx.fillStyle=vig;ctx.fillRect(0,0,canvas.width,canvas.height);
    const core=ctx.createRadialGradient(cx,cy,0,cx,cy,80+Math.sin(cyberTime*3)*15);core.addColorStop(0,'rgba(200,220,255,0.9)');core.addColorStop(0.2,'rgba(100,160,255,0.4)');core.addColorStop(0.5,'rgba(60,0,200,0.15)');core.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=core;ctx.fillRect(0,0,canvas.width,canvas.height);
    const topFade=ctx.createLinearGradient(0,0,0,cy*0.6);topFade.addColorStop(0,'rgba(0,0,5,0.6)');topFade.addColorStop(1,'rgba(0,0,5,0)');ctx.fillStyle=topFade;ctx.fillRect(0,0,canvas.width,cy*0.6);
  }
}

// â”€â”€ CROSSHAIR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCrosshair(){
  const dark=['night','space','neonCyber','retroCity','synthSpace','hyperspace'];
  ctx.strokeStyle = dark.includes(map) ? '#fff' : '#000';
  ctx.lineWidth = isMobile ? 3 : 2; // Thicker crosshair on mobile
  
  if(crosshair === 'dot'){
    ctx.beginPath();
    ctx.arc(mouseX, mouseY, isMobile ? 8 : 5, 0, Math.PI*2);
    ctx.stroke();
  }
  else if(crosshair === 'scope'){
    ctx.beginPath();
    const scopeRadius = isMobile ? 24 : 18;
    const scopeLineLength = isMobile ? 32 : 25;
    ctx.arc(mouseX, mouseY, scopeRadius, 0, Math.PI*2);
    ctx.moveTo(mouseX - scopeLineLength, mouseY);
    ctx.lineTo(mouseX + scopeLineLength, mouseY);
    ctx.moveTo(mouseX, mouseY - scopeLineLength);
    ctx.lineTo(mouseX, mouseY + scopeLineLength);
    ctx.stroke();
  }
  else if(crosshair === 'cross'){
    const crossLength = isMobile ? 20 : 15;
    ctx.beginPath();
    ctx.moveTo(mouseX - crossLength, mouseY);
    ctx.lineTo(mouseX + crossLength, mouseY);
    ctx.moveTo(mouseX, mouseY - crossLength);
    ctx.lineTo(mouseX, mouseY + crossLength);
    ctx.stroke();
  }
}

// â”€â”€ GUN DRAWING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawGun(){
  if(!running) return;
  const gx = GUN_X();
  const gy = GUN_Y();
  const angle = Math.atan2(mouseY - gy, mouseX - gx) + Math.PI / 2;
  ctx.save();
  ctx.translate(gx, gy);
  ctx.rotate(angle);

  if(blaster==='pistol')      drawPistol();
  else if(blaster==='revolver')  drawRevolver();
  else if(blaster==='shotgun')   drawShotgun();
  else if(blaster==='uzi')       drawUzi();
  else if(blaster==='rifle')     drawRifle();
  else if(blaster==='sniper')    drawSniper();
  else if(blaster==='minigun')   drawMinigun();
  else if(blaster==='railgun')   drawRailgun();
  else if(blaster==='plasma')    drawPlasma();
  else if(blaster==='laser')     drawLaser();
  else if(blaster==='vortex')    drawVortex();
  else if(blaster==='thunder')   drawThunder();
  else if(blaster==='cryo')      drawCryo();
  else if(blaster==='inferno')   drawInferno();
  else if(blaster==='gravity')   drawGravity();
  else if(blaster==='quantum')   drawQuantum();
  else if(blaster==='void')      drawVoid();
  else if(blaster==='nova')      drawNova();
  else if(blaster==='omega')     drawOmega();
  else if(blaster==='celestialbeam') drawCelestialbeam();

  ctx.restore();
  if(gunRecoil > 0) gunRecoil -= 2;
  if(muzzleFlash > 0) muzzleFlash -= 1;
}

// â”€â”€ GUN DRAW FUNCTIONS (keeping all the original gun drawing code) â”€â”€â”€â”€â”€â”€â”€â”€
// I'm keeping the same gun drawing functions from before to save space
// They all use the same visual style with the useShadow variable

function drawPistol(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-35,10,70,50);ctx.fillRect(-20,50,40,20);ctx.fillRect(-15,-5,15,20);ctx.fillRect(5,35,12,30);ctx.fillRect(-10,40,12,25);
  ctx.fillStyle='#2c3e50';ctx.fillRect(-15,-30,25,80);ctx.fillRect(-25,-60,20,30);
  ctx.fillStyle='#1a252f';ctx.fillRect(-12,-100,10,40);ctx.fillRect(5,-15,15,8);
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=30;ctx.shadowColor='#ffaa00';}ctx.fillStyle='#ffff00';ctx.beginPath();ctx.moveTo(-2,-100);for(let i=0;i<8;i++){const r=40+Math.random()*20,a=(i/8)*Math.PI*2;ctx.lineTo(-2+Math.sin(a)*r,-100-Math.cos(a)*r);}ctx.fill();if(useShadow)ctx.shadowBlur=0;}
}
function drawRevolver(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-35,15,70,45);ctx.fillRect(-20,50,40,18);
  ctx.fillStyle='#8b4513';ctx.fillRect(-18,-20,36,40);
  ctx.fillStyle='#2c3e50';ctx.beginPath();ctx.arc(0,-10,22,0,Math.PI*2);ctx.fill();
  for(let i=0;i<6;i++){const a=(i/6)*Math.PI*2;ctx.fillStyle='#1a252f';ctx.beginPath();ctx.arc(Math.cos(a)*12,-10+Math.sin(a)*12,4,0,Math.PI*2);ctx.fill();}
  ctx.fillStyle='#34495e';ctx.fillRect(-8,-120,16,100);ctx.fillStyle='#1a252f';ctx.fillRect(8,-10,15,10);
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=40;ctx.shadowColor='#ff8800';}ctx.fillStyle='#ffff00';ctx.beginPath();ctx.moveTo(0,-120);for(let i=0;i<8;i++){const r=50+Math.random()*25,a=(i/8)*Math.PI*2;ctx.lineTo(Math.sin(a)*r,-120-Math.cos(a)*r);}ctx.fill();if(useShadow)ctx.shadowBlur=0;}
}
function drawShotgun(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-30,10,60,45);ctx.fillRect(-18,45,30,18);ctx.fillRect(-25,-80,50,55);ctx.fillRect(-18,-35,40,18);
  ctx.fillStyle='#2c3e50';ctx.fillRect(-12,-180,20,180);ctx.fillStyle='#8b4513';ctx.fillRect(-10,-110,16,60);ctx.fillStyle='#34495e';ctx.fillRect(-18,-30,30,50);ctx.fillStyle='#1a252f';ctx.fillRect(8,-15,15,8);
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=40;ctx.shadowColor='#ffaa00';}ctx.fillStyle='#ffff00';ctx.beginPath();ctx.moveTo(-2,-180);for(let i=0;i<10;i++){const r=60+Math.random()*30,a=(i/10)*Math.PI*2;ctx.lineTo(-2+Math.sin(a)*r,-180-Math.cos(a)*r);}ctx.fill();if(useShadow)ctx.shadowBlur=0;}
}
function drawUzi(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-22,15,44,35);ctx.fillRect(-15,42,28,15);
  ctx.fillStyle='#2c3e50';ctx.fillRect(-8,-140,14,140);ctx.fillStyle='#1a252f';ctx.fillRect(-18,-20,36,40);ctx.fillStyle='#34495e';ctx.fillRect(-12,-50,24,35);ctx.fillStyle='#1a252f';ctx.fillRect(8,-8,12,8);
  for(let i=0;i<8;i++){ctx.fillRect(-6,-135+i*16,2,8);ctx.fillRect(8,-135+i*16,2,8);}
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=25;ctx.shadowColor='#ffaa00';}ctx.fillStyle='#ffff00';ctx.beginPath();ctx.moveTo(0,-140);for(let i=0;i<8;i++){const r=30+Math.random()*15,a=(i/8)*Math.PI*2;ctx.lineTo(Math.sin(a)*r,-140-Math.cos(a)*r);}ctx.fill();if(useShadow)ctx.shadowBlur=0;}
}
function drawRifle(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-27,10,55,40);ctx.fillRect(-19,38,30,15);ctx.fillRect(-22,-130,45,50);ctx.fillRect(-17,-90,38,15);
  ctx.fillStyle='#2c3e50';ctx.fillRect(-10,-220,18,220);ctx.fillStyle='#34495e';ctx.fillRect(-20,-150,12,80);ctx.fillRect(-30,-180,40,10);ctx.fillStyle='#2c3e50';ctx.fillRect(-20,-30,20,70);ctx.fillStyle='#1a252f';ctx.fillRect(-15,-10,50,30);ctx.fillRect(-60,-8,60,18);ctx.fillRect(8,-8,12,8);
  for(let i=0;i<12;i++){ctx.fillRect(-8,-215+i*12,3,6);ctx.fillRect(11,-215+i*12,3,6);}
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=25;ctx.shadowColor='#ff9900';}ctx.fillStyle='#ffff00';ctx.beginPath();ctx.moveTo(0,-220);for(let i=0;i<8;i++){const r=35+Math.random()*15,a=(i/8)*Math.PI*2;ctx.lineTo(Math.sin(a)*r,-220-Math.cos(a)*r);}ctx.fill();if(useShadow)ctx.shadowBlur=0;}
}
function drawSniper(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-25,15,50,35);ctx.fillRect(-15,40,25,15);
  ctx.fillStyle='#2c3e50';ctx.fillRect(-8,-140,14,140);ctx.fillStyle='#1a252f';ctx.fillRect(-25,-160,50,20);ctx.fillStyle='#34495e';ctx.fillRect(-15,-80,30,60);
  ctx.fillStyle='#000';ctx.fillRect(-20,-130,40,3);ctx.fillRect(-1.5,-140,3,20);
  ctx.strokeStyle='#555';ctx.lineWidth=15;ctx.beginPath();ctx.arc(0,-120,25,0,Math.PI*2);ctx.stroke();
  ctx.fillStyle='rgba(100,150,255,0.3)';ctx.beginPath();ctx.arc(0,-120,22,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#1a252f';ctx.fillRect(-70,-10,70,20);ctx.fillRect(8,-10,12,8);
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=50;ctx.shadowColor='#ffaa00';}ctx.fillStyle='#ffff00';ctx.beginPath();ctx.moveTo(0,-160);for(let i=0;i<6;i++){const r=35+Math.random()*15,a=(i/6)*Math.PI*2;ctx.lineTo(Math.sin(a)*r,-160-Math.cos(a)*r);}ctx.fill();if(useShadow)ctx.shadowBlur=0;}
}
function drawMinigun(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-30,20,60,40);ctx.fillRect(-20,50,40,18);ctx.fillStyle='#34495e';ctx.fillRect(-35,-10,70,35);
  for(let i=0;i<6;i++){const o=(i-2.5)*12;ctx.fillStyle='#2c3e50';ctx.fillRect(o-4,-200,8,190);}
  ctx.fillStyle='#1a252f';ctx.fillRect(-40,-220,80,20);ctx.fillRect(-25,10,50,15);
  if(muzzleFlash>0){for(let i=0;i<6;i++){const o=(i-2.5)*12;if(useShadow){ctx.shadowBlur=20;ctx.shadowColor='#ff9900';}ctx.fillStyle='#ffff00';ctx.beginPath();ctx.moveTo(o,-200);for(let j=0;j<6;j++){const r=25+Math.random()*15,a=(j/6)*Math.PI*2;ctx.lineTo(o+Math.sin(a)*r,-200-Math.cos(a)*r);}ctx.fill();}if(useShadow)ctx.shadowBlur=0;}
}
function drawRailgun(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-28,18,56,38);ctx.fillRect(-18,48,36,16);ctx.fillStyle='#00d4ff';ctx.fillRect(-15,-250,30,250);ctx.fillStyle='#0088cc';ctx.fillRect(-12,-248,24,246);
  ctx.fillStyle='#00ffff';for(let i=0;i<15;i++)ctx.fillRect(-10,-240+i*16,20,4);
  ctx.fillStyle='#1a252f';ctx.fillRect(-25,-20,50,40);ctx.fillStyle='#00d4ff';if(useShadow){ctx.shadowBlur=15;ctx.shadowColor='#00ffff';}ctx.fillRect(-18,-260,36,10);if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=60;ctx.shadowColor='#00ffff';}ctx.fillStyle='#ffffff';ctx.beginPath();ctx.moveTo(0,-260);for(let i=0;i<8;i++){const r=80+Math.random()*40,a=(i/8)*Math.PI*2;ctx.lineTo(Math.sin(a)*r,-260-Math.cos(a)*r);}ctx.fill();if(useShadow)ctx.shadowBlur=0;}
}
function drawPlasma(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-32,16,64,42);ctx.fillRect(-22,50,44,18);ctx.fillStyle='#9d4edd';ctx.fillRect(-20,-180,40,180);ctx.fillStyle='#7209b7';ctx.fillRect(-16,-176,32,172);
  for(let i=0;i<10;i++){ctx.fillStyle=i%2===0?'#ff006e':'#9d4edd';ctx.beginPath();ctx.arc(-8,-160+i*16,6,0,Math.PI*2);ctx.arc(8,-160+i*16,6,0,Math.PI*2);ctx.fill();}
  ctx.fillStyle='#1a252f';ctx.fillRect(-28,-20,56,40);ctx.fillStyle='#ff006e';if(useShadow){ctx.shadowBlur=20;ctx.shadowColor='#9d4edd';}ctx.beginPath();ctx.arc(0,-190,18,0,Math.PI*2);ctx.fill();if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=50;ctx.shadowColor='#ff006e';}ctx.fillStyle='#9d4edd';ctx.beginPath();ctx.moveTo(0,-200);for(let i=0;i<10;i++){const r=60+Math.random()*30,a=(i/10)*Math.PI*2;ctx.lineTo(Math.sin(a)*r,-200-Math.cos(a)*r);}ctx.fill();if(useShadow)ctx.shadowBlur=0;}
}
function drawLaser(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-26,18,52,36);ctx.fillRect(-18,46,36,16);ctx.fillStyle='#ff0000';ctx.fillRect(-10,-220,20,220);ctx.fillStyle='#cc0000';ctx.fillRect(-7,-218,14,216);
  ctx.fillStyle='#ff6666';for(let i=0;i<20;i++)ctx.fillRect(-5,-215+i*10,10,3);
  ctx.fillStyle='#1a252f';ctx.fillRect(-22,-18,44,38);ctx.fillStyle='#ff0000';if(useShadow){ctx.shadowBlur=25;ctx.shadowColor='#ff0000';}ctx.beginPath();ctx.arc(0,-230,12,0,Math.PI*2);ctx.fill();if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=40;ctx.shadowColor='#ff0000';}ctx.strokeStyle='#ffffff';ctx.lineWidth=8;ctx.beginPath();ctx.moveTo(0,-230);ctx.lineTo(0,-400);ctx.stroke();if(useShadow)ctx.shadowBlur=0;}
}

function drawVortex(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-30,15,60,42);ctx.fillRect(-20,50,38,16);
  ctx.fillStyle='#00cc88';ctx.fillRect(-18,-200,14,200);ctx.fillRect(4,-200,14,200);
  ctx.fillStyle='#009966';ctx.fillRect(-16,-198,10,196);ctx.fillRect(6,-198,10,196);
  for(let i=0;i<10;i++){ctx.fillStyle=i%2===0?'#00ffaa':'#007755';ctx.fillRect(-17,-190+i*19,12,6);ctx.fillRect(5,-190+i*19,12,6);}
  ctx.fillStyle='#1a252f';ctx.fillRect(-28,-18,56,38);
  ctx.fillStyle='#00ffaa';if(useShadow){ctx.shadowBlur=20;ctx.shadowColor='#00ffcc';}
  ctx.beginPath();ctx.arc(-11,-208,8,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(11,-208,8,0,Math.PI*2);ctx.fill();
  if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=35;ctx.shadowColor='#00ffaa';}ctx.fillStyle='#aaffee';
    for(const ox of[-11,11]){ctx.beginPath();ctx.moveTo(ox,-208);for(let i=0;i<8;i++){const r=40+Math.random()*20,a=(i/8)*Math.PI*2;ctx.lineTo(ox+Math.sin(a)*r,-208-Math.cos(a)*r);}ctx.fill();}if(useShadow)ctx.shadowBlur=0;}
}

function drawThunder(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-34,14,68,44);ctx.fillRect(-24,52,46,18);
  ctx.fillStyle='#4a3000';ctx.fillRect(-20,-160,40,160);
  ctx.fillStyle='#ffcc00';
  for(let i=0;i<8;i++){ctx.beginPath();ctx.arc(0,-20-i*18,14-i*0.3,0,Math.PI*2);ctx.stroke?ctx.stroke():null;ctx.fillStyle=i%2===0?'#ffcc00':'#ff9900';ctx.beginPath();ctx.arc(-12,-20-i*18,5,0,Math.PI*2);ctx.arc(12,-20-i*18,5,0,Math.PI*2);ctx.fill();}
  ctx.fillStyle='#1a252f';ctx.fillRect(-28,-22,56,44);
  ctx.fillStyle='#ffee00';if(useShadow){ctx.shadowBlur=25;ctx.shadowColor='#ffcc00';}
  ctx.fillRect(-22,-170,44,12);
  if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=60;ctx.shadowColor='#ffff00';}ctx.strokeStyle='#ffffff';ctx.lineWidth=4;
    for(let i=0;i<5;i++){ctx.beginPath();const sx=0,sy=-170;ctx.moveTo(sx,sy);let cx2=sx,cy2=sy;for(let j=0;j<4;j++){cx2+=(Math.random()-0.5)*30;cy2-=15+Math.random()*10;ctx.lineTo(cx2,cy2);}ctx.stroke();}if(useShadow)ctx.shadowBlur=0;}
}

function drawCryo(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-32,14,64,44);ctx.fillRect(-22,50,42,16);
  ctx.fillStyle='#88ccff';ctx.fillRect(-18,-210,36,210);ctx.fillStyle='#55aaee';ctx.fillRect(-14,-206,28,202);
  ctx.fillStyle='#aaddff';for(let i=0;i<12;i++){ctx.fillRect(-13,-200+i*16,26,4);}
  ctx.fillStyle='#1a252f';ctx.fillRect(-30,-22,60,44);
  ctx.fillStyle='#cceeff';if(useShadow){ctx.shadowBlur=20;ctx.shadowColor='#88ccff';}
  ctx.beginPath();ctx.arc(0,-218,14,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='#ffffff';ctx.lineWidth=1.5;
  for(let i=0;i<6;i++){const a=(i/6)*Math.PI*2,bx=Math.cos(a)*22,by=-120+Math.sin(a)*10;ctx.beginPath();ctx.moveTo(bx,by);ctx.lineTo(bx+Math.cos(a)*8,by+Math.sin(a)*8);ctx.stroke();}
  if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=40;ctx.shadowColor='#aaddff';}ctx.fillStyle='#ffffff';
    for(let i=0;i<7;i++){const a=(i/7)*Math.PI*2,r=30+Math.random()*20;ctx.beginPath();ctx.moveTo(0,-218);ctx.lineTo(Math.sin(a)*r,-218-Math.cos(a)*r);ctx.lineTo(Math.sin(a+0.3)*r*0.5,-218-Math.cos(a+0.3)*r*0.5);ctx.fill();}if(useShadow)ctx.shadowBlur=0;}
}

function drawInferno(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-36,16,72,44);ctx.fillRect(-26,54,50,18);
  ctx.fillStyle='#8b3a00';ctx.fillRect(-22,-140,44,140);ctx.fillStyle='#cc5500';ctx.fillRect(-18,-136,36,132);
  for(let i=0;i<7;i++){ctx.fillStyle=i%2===0?'#ff6600':'#ff3300';ctx.fillRect(-17,-128+i*18,34,8);}
  ctx.fillStyle='#1a252f';ctx.fillRect(-30,-22,60,44);ctx.fillRect(-16,-12,60,22);
  ctx.fillStyle='#ff4400';if(useShadow){ctx.shadowBlur=20;ctx.shadowColor='#ff6600';}
  ctx.beginPath();ctx.arc(0,-148,20,0,Math.PI*2);ctx.fill();if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=50;ctx.shadowColor='#ff4400';}
    for(let i=0;i<12;i++){const a=(i/12)*Math.PI*2,r=30+Math.random()*40,hue=Math.random()>0.5?'#ff6600':'#ffcc00';ctx.fillStyle=hue;ctx.beginPath();ctx.ellipse(Math.sin(a)*r*0.5,-148-Math.abs(Math.cos(a))*r,8,5,a,0,Math.PI*2);ctx.fill();}if(useShadow)ctx.shadowBlur=0;}
}

function drawGravity(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-30,18,60,40);ctx.fillRect(-20,50,38,16);
  ctx.fillStyle='#440088';ctx.fillRect(-16,-200,32,200);ctx.fillStyle='#6600cc';ctx.fillRect(-12,-196,24,192);
  for(let i=0;i<8;i++){const w=24-i*1.5,y=-30-i*20;ctx.strokeStyle=i%2===0?'#cc44ff':'#8800ff';ctx.lineWidth=3;ctx.beginPath();ctx.ellipse(0,y,w,6,0,0,Math.PI*2);ctx.stroke();}
  ctx.fillStyle='#1a252f';ctx.fillRect(-28,-20,56,40);
  ctx.fillStyle='#9900ff';if(useShadow){ctx.shadowBlur=25;ctx.shadowColor='#cc44ff';}
  ctx.beginPath();ctx.moveTo(-30,-200);ctx.lineTo(30,-200);ctx.lineTo(16,-210);ctx.lineTo(-16,-210);ctx.closePath();ctx.fill();if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=60;ctx.shadowColor='#cc44ff';}ctx.fillStyle='#ffffff';
    ctx.beginPath();ctx.arc(0,-205,35,0,Math.PI*2);ctx.fill();
    for(let i=1;i<=3;i++){ctx.strokeStyle=`rgba(200,100,255,${1-i*0.3})`;ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,-205,35+i*18,0,Math.PI*2);ctx.stroke();}if(useShadow)ctx.shadowBlur=0;}
}

function drawQuantum(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-28,16,56,42);ctx.fillRect(-18,50,34,16);
  ctx.fillStyle='#334455';ctx.fillRect(-12,-230,24,230);ctx.fillStyle='#556677';ctx.fillRect(-9,-226,18,222);
  for(let i=0;i<12;i++){const t=i/12;ctx.strokeStyle=`hsl(${200+t*60},80%,${60+t*20}%)`;ctx.lineWidth=2;ctx.beginPath();ctx.ellipse(0,-20-i*17,16,5,0,0,Math.PI*2);ctx.stroke();}
  ctx.fillStyle='#1a252f';ctx.fillRect(-26,-20,52,40);
  ctx.fillStyle='#99ddff';if(useShadow){ctx.shadowBlur=20;ctx.shadowColor='#66aaff';}
  ctx.beginPath();ctx.arc(0,-238,16,0,Math.PI*2);ctx.fill();if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=50;ctx.shadowColor='#99ddff';}
    for(let i=0;i<5;i++){ctx.fillStyle=`rgba(150,220,255,${0.3-i*0.05})`;ctx.beginPath();ctx.arc((Math.random()-0.5)*20,-238,30+i*10,0,Math.PI*2);ctx.fill();}if(useShadow)ctx.shadowBlur=0;}
}

function drawVoid(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-34,16,68,44);ctx.fillRect(-24,52,46,18);
  ctx.fillStyle='#111';ctx.fillRect(-20,-240,40,240);ctx.fillStyle='#1a001a';ctx.fillRect(-16,-236,32,232);
  for(let i=0;i<14;i++){ctx.fillStyle=i%2===0?'#220022':'#330033';ctx.fillRect(-15,-228+i*16,30,6);}
  ctx.fillStyle='#1a252f';ctx.fillRect(-32,-22,64,44);
  const vPulse=0.8+Math.sin(Date.now()*0.005)*0.2;
  ctx.fillStyle='#000';if(useShadow){ctx.shadowBlur=30;ctx.shadowColor='#660066';}
  ctx.beginPath();ctx.arc(0,-248,18*vPulse,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='#aa00aa';ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,-248,20,0,Math.PI*2);ctx.stroke();if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=60;ctx.shadowColor='#aa00aa';}
    ctx.fillStyle='rgba(80,0,80,0.9)';ctx.beginPath();ctx.arc(0,-248,50,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(0,0,0,0.95)';ctx.beginPath();ctx.arc(0,-248,30,0,Math.PI*2);ctx.fill();if(useShadow)ctx.shadowBlur=0;}
}

function drawNova(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-30,16,60,42);ctx.fillRect(-20,50,38,16);
  ctx.fillStyle='#7a4000';ctx.fillRect(-14,-200,28,200);ctx.fillStyle='#cc8800';ctx.fillRect(-10,-196,20,192);
  for(let i=0;i<10;i++){ctx.strokeStyle=i%2===0?'#ffaa00':'#ff6600';ctx.lineWidth=2;ctx.beginPath();ctx.ellipse(0,-20-i*18,14,5,0,0,Math.PI*2);ctx.stroke();}
  ctx.fillStyle='#1a252f';ctx.fillRect(-28,-22,56,44);
  ctx.fillStyle='#ffdd00';if(useShadow){ctx.shadowBlur=25;ctx.shadowColor='#ffaa00';}
  for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2;ctx.beginPath();ctx.moveTo(0,-206);ctx.lineTo(Math.sin(a)*20,-206-Math.cos(a)*20);ctx.lineTo(Math.sin(a+0.2)*12,-206-Math.cos(a+0.2)*12);ctx.closePath();ctx.fill();}
  ctx.fillStyle='#ffffff';ctx.beginPath();ctx.arc(0,-206,8,0,Math.PI*2);ctx.fill();if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=50;ctx.shadowColor='#ffcc00';}
    for(let i=0;i<12;i++){const a=(i/12)*Math.PI*2,r=25+Math.random()*35;ctx.fillStyle=Math.random()>0.5?'#ffcc00':'#ff8800';ctx.beginPath();ctx.moveTo(0,-206);ctx.lineTo(Math.sin(a)*r,-206-Math.cos(a)*r);ctx.lineTo(Math.sin(a+0.15)*r*0.6,-206-Math.cos(a+0.15)*r*0.6);ctx.closePath();ctx.fill();}if(useShadow)ctx.shadowBlur=0;}
}

function drawOmega(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-40,20,80,46);ctx.fillRect(-28,60,54,20);
  ctx.fillStyle='#2a0000';ctx.fillRect(-28,-260,22,260);ctx.fillRect(6,-260,22,260);
  ctx.fillStyle='#550000';ctx.fillRect(-25,-256,16,252);ctx.fillRect(9,-256,16,252);
  for(let i=0;i<14;i++){ctx.fillStyle=i%2===0?'#880000':'#cc0000';ctx.fillRect(-24,-248+i*18,14,7);ctx.fillRect(10,-248+i*18,14,7);}
  ctx.fillStyle='#1a252f';ctx.fillRect(-38,-24,76,48);ctx.fillRect(-50,-12,50,24);
  ctx.fillStyle='#ff2200';if(useShadow){ctx.shadowBlur=25;ctx.shadowColor='#ff0000';}
  ctx.fillRect(-32,-268,20,10);ctx.fillRect(12,-268,20,10);if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){if(useShadow){ctx.shadowBlur=50;ctx.shadowColor='#ff2200';}
    for(const ox of[-17,17]){ctx.fillStyle='#ff4400';ctx.beginPath();ctx.moveTo(ox,-268);for(let i=0;i<10;i++){const r=50+Math.random()*30,a=(i/10)*Math.PI*2;ctx.lineTo(ox+Math.sin(a)*r,-268-Math.cos(a)*r);}ctx.fill();}if(useShadow)ctx.shadowBlur=0;}
}

function drawCelestialbeam(){
  const useShadow = !isMobile;
  ctx.fillStyle='#d4a574';ctx.fillRect(-44,22,88,48);ctx.fillRect(-32,64,62,22);
  const grd=ctx.createLinearGradient(0,-300,0,0);
  grd.addColorStop(0,'#ffffff');grd.addColorStop(0.15,'#ffccff');grd.addColorStop(0.3,'#ccccff');
  grd.addColorStop(0.45,'#ccffff');grd.addColorStop(0.6,'#ccffcc');grd.addColorStop(0.75,'#ffffcc');
  grd.addColorStop(0.9,'#ffcccc');grd.addColorStop(1,'#d4a574');
  ctx.fillStyle=grd;ctx.fillRect(-24,-300,48,300);
  for(let i=0;i<20;i++){const hue=(i/20)*360;ctx.strokeStyle=`hsla(${hue},100%,70%,0.8)`;ctx.lineWidth=3;if(useShadow){ctx.shadowBlur=8;ctx.shadowColor=`hsl(${hue},100%,70%)`;}ctx.beginPath();ctx.ellipse(0,-15-i*14,22,7,0,0,Math.PI*2);ctx.stroke();}if(useShadow)ctx.shadowBlur=0;
  ctx.fillStyle='#1a252f';ctx.fillRect(-42,-26,84,52);ctx.fillRect(-60,-14,60,28);
  const t=Date.now()*0.003;
  if(useShadow){ctx.shadowBlur=40;ctx.shadowColor='#ffffff';}
  for(let i=0;i<16;i++){const a=(i/16)*Math.PI*2+t;const r=i%2===0?38:22;ctx.fillStyle=`hsl(${(i/16)*360},100%,75%)`;ctx.beginPath();ctx.moveTo(0,-308);ctx.lineTo(Math.sin(a)*r,-308-Math.cos(a)*r);ctx.lineTo(Math.sin(a+0.2)*r*0.5,-308-Math.cos(a+0.2)*r*0.5);ctx.closePath();ctx.fill();}
  ctx.fillStyle='#ffffff';ctx.beginPath();ctx.arc(0,-308,12,0,Math.PI*2);ctx.fill();if(useShadow)ctx.shadowBlur=0;
  if(muzzleFlash>0){
    const colGrd=ctx.createLinearGradient(0,-308,0,-600);colGrd.addColorStop(0,'rgba(255,255,255,0.95)');colGrd.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=colGrd;ctx.fillRect(-40,-600,80,300);
    if(useShadow){ctx.shadowBlur=80;ctx.shadowColor='#ffffff';}
    for(let i=0;i<20;i++){const a=(i/20)*Math.PI*2,r=60+Math.random()*50;const hue=(i/20)*360;ctx.fillStyle=`hsla(${hue},100%,80%,0.9)`;ctx.beginPath();ctx.moveTo(0,-308);ctx.lineTo(Math.sin(a)*r,-308-Math.abs(Math.cos(a))*r);ctx.lineTo(Math.sin(a+0.15)*r*0.6,-308-Math.abs(Math.cos(a+0.15))*r*0.6);ctx.closePath();ctx.fill();}if(useShadow)ctx.shadowBlur=0;}
}

// â”€â”€ GAME LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gameLoop(){
  drawBackground();
  if(!paused){
    enemies.forEach(e => {
      e.update();
      e.draw();
    });
    enemies = enemies.filter(e => !e.isOffScreen());
    if(boss){
      boss.update();
      boss.draw();
      if(boss.isOffScreen()) boss = null;
    }
  } else {
    enemies.forEach(e => e.draw());
    if(boss) boss.draw();
  }
  drawGun();
  drawCrosshair();
  document.getElementById('score').textContent = score;
  requestAnimationFrame(gameLoop);
}

// â”€â”€ START / END â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(){
  if(!audioCtx) audioCtx = new(window.AudioContext || window.webkitAudioContext)();
  score = 0;
  level = 1;
  prevLevel = 1;
  enemies = [];
  boss = null;
  running = true;
  paused = false;
  enemiesHitCount = 0;
  bossesDefeatedCount = 0;
  gunRecoil = 0;
  muzzleFlash = 0;
  shotsHit = 0;
  shotsFired = 0;
  missedShots = 0;
  sessionHits = 0;
  
  document.getElementById('score').textContent = '0';
  document.getElementById('level').textContent = '1';
  document.getElementById('hitsDisplay').textContent = '0';
  document.getElementById('nextLevelInfo').textContent = 'Lvl 3 in 50';
  document.getElementById('accuracy').textContent = '100';
  document.getElementById('misses').textContent = '0';
  document.getElementById('bestHitsDisplay').textContent = allTimeHits;
  document.getElementById('gameOver').style.display = 'none';
  document.getElementById('pauseOverlay').style.display = 'none';
  document.getElementById('mainMenu').style.display = 'none';
  document.getElementById('ui').style.display = 'block';
  
  if (isMobile) {
    shootButton.style.display = 'flex';
  }
  
  spawnInterval = setInterval(spawn, 900);
  startBackgroundMusic();
}

function endGame(){
  running = false;
  if(spawnInterval) clearInterval(spawnInterval);
  if(rapidFireTimeout) clearInterval(rapidFireTimeout);
  isShootingMobile = false;
  shootButton.style.display = 'none';
  stopBackgroundMusic();
  
  if(score > highScore) highScore = score;
  saveProgress();
  
  const acc = shotsFired > 0 ? Math.round((shotsHit / shotsFired) * 100) : 100;
  const nu = checkAndUnlockWeapons();
  
  document.getElementById('finalScoreValue').textContent = score;
  document.getElementById('finalLevel').textContent = level;
  document.getElementById('finalHits').textContent = sessionHits;
  document.getElementById('finalAccuracy').textContent = acc;
  document.getElementById('enemiesHit').textContent = enemiesHitCount;
  document.getElementById('bossesDefeated').textContent = bossesDefeatedCount;
  
  const um = document.getElementById('newUnlockMsg');
  if(nu.length){
    um.textContent = 'ðŸ”“ Unlocked: ' + nu.join(', ') + '!';
    um.style.display = 'block';
  }
  else um.style.display = 'none';
  
  document.getElementById('gameOver').style.display = 'block';
  setTimeout(() => {
    document.getElementById('mainMenu').style.display = 'flex';
    document.getElementById('gameOver').style.display = 'none';
    document.getElementById('ui').style.display = 'none';
  }, 4000);
}

// â”€â”€ SHOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderShop(){
  const grid = document.getElementById('shopGrid');
  grid.innerHTML = '';
  weapons.forEach(w => {
    const isUnlocked = unlockedWeapons.includes(w.id);
    const isEquipped = blaster === w.id;
    const canUnlock = allTimeHits >= w.hitsRequired;
    const div = document.createElement('div');
    div.className = 'shopItem';
    if(isUnlocked) div.classList.add('unlocked');
    if(isEquipped) div.classList.add('equipped');
    const h3 = document.createElement('h3');
    h3.textContent = w.name;
    const desc = document.createElement('p');
    desc.textContent = w.description;
    const hint = document.createElement('p');
    hint.style.fontSize = '12px';
    hint.style.color = '#aaa';
    hint.textContent = w.hitsRequired === 0 ? 'No hits required' : `Requires ${w.hitsRequired} total hits`;
    const status = document.createElement('p');
    if(isEquipped){
      status.textContent = 'âœ“ EQUIPPED';
      status.style.color = '#FFD700';
      status.style.fontWeight = 'bold';
    }
    else if(isUnlocked){
      status.textContent = 'âœ“ Unlocked (permanent)';
      status.style.color = '#4CAF50';
    }
    else if(canUnlock){
      status.textContent = 'Ready to unlock!';
      status.style.color = '#FFD700';
    }
    else{
      status.textContent = `ðŸ”’ ${w.hitsRequired - allTimeHits} more hits needed`;
      status.style.color = '#ff6b6b';
    }
    const btn = document.createElement('button');
    if(isEquipped){
      btn.textContent = 'EQUIPPED';
      btn.disabled = true;
      btn.style.background = '#FFD700';
    }
    else if(isUnlocked){
      btn.textContent = 'EQUIP';
      btn.onclick = () => {
        blaster = w.id;
        renderShop();
      };
    }
    else if(canUnlock){
      btn.textContent = 'UNLOCK FOREVER';
      btn.style.background = '#ff9800';
      btn.onclick = () => {
        unlockedWeapons.push(w.id);
        saveProgress();
        blaster = w.id;
        renderShop();
      };
    }
    else{
      btn.textContent = 'LOCKED';
      btn.disabled = true;
    }
    div.appendChild(h3);
    div.appendChild(desc);
    div.appendChild(hint);
    div.appendChild(status);
    div.appendChild(btn);
    grid.appendChild(div);
  });
}

document.getElementById('playBtn').onclick = () => startGame();
document.getElementById('shopBtn').onclick = () => {
  document.getElementById('mainMenu').style.display = 'none';
  document.getElementById('shopMenu').style.display = 'flex';
  renderShop();
};
document.getElementById('backToMenu').onclick = () => {
  document.getElementById('shopMenu').style.display = 'none';
  document.getElementById('mainMenu').style.display = 'flex';
};
document.getElementById('playAgainBtn').onclick = () => {
  document.getElementById('gameOver').style.display = 'none';
  startGame();
};

checkAndUnlockWeapons();
renderShop();
gameLoop();
</script>
</body>
</html>